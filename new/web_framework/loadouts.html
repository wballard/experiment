<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loadouts - Courier</title>
    <link rel="stylesheet" href="assets/css/design-system.css?v=13">
    <link rel="stylesheet" href="assets/css/main.css?v=13">
    <link rel="stylesheet" href="assets/css/game.css?v=13">
    <style>
        /* Loadout-specific styles using Courier design system */
        .loadout-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Loadout Preset Buttons */
        .loadout-tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .loadout-tab {
            background: var(--bg-medium);
            border: 2px solid var(--border-gray);
            color: var(--text-normal);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .loadout-tab:hover {
            background: var(--bg-light);
            border-color: var(--primary-cyan);
            color: var(--primary-cyan);
        }

        .loadout-tab.active {
            background: var(--primary-cyan);
            border-color: var(--primary-cyan);
            color: var(--bg-black);
        }
        
        .loadout-tab.activated {
            background: linear-gradient(145deg, var(--primary-orange), #ff8800);
            border-color: var(--primary-orange);
            color: var(--bg-black);
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.4);
            position: relative;
            animation: active-loadout-glow 3s ease-in-out infinite alternate;
        }
        
        @keyframes active-loadout-glow {
            0% {
                box-shadow: 0 0 15px rgba(255, 107, 0, 0.4);
            }
            100% {
                box-shadow: 0 0 20px rgba(255, 107, 0, 0.6);
            }
        }
        
        .loadout-tab.activated::after {
            content: "ACTIVE";
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary-orange);
            color: var(--bg-black);
            font-size: 8px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid var(--bg-black);
            letter-spacing: 0.5px;
        }

        .loadout-tab.empty {
            border-style: dashed;
            opacity: 0.6;
        }

        /* Main Loadout Card */
        .loadout-card {
            background: var(--bg-dark);
            border: 1px solid var(--border-gray);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
        }

        .loadout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }

        .loadout-title {
            font-size: 28px;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--primary-cyan);
        }

        .edit-button {
            background: transparent;
            border: 1px solid var(--border-gray);
            color: var(--text-normal);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .edit-button:hover {
            background: var(--bg-light);
            color: var(--primary-cyan);
            border-color: var(--primary-cyan);
        }

        /* Ability Sections */
        .ability-section {
            margin-bottom: var(--spacing-xl);
        }

        .section-title {
            font-size: 14px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: var(--spacing-md);
        }

        .abilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-md);
        }

        .ability-slot {
            background: var(--bg-medium);
            border: 2px solid var(--border-gray);
            border-radius: 4px;
            padding: var(--spacing-md);
            text-align: center;
            transition: all 0.3s ease;
        }

        .ability-slot:hover {
            border-color: var(--primary-cyan);
            background: var(--bg-light);
        }

        .ability-icon {
            width: 56px;
            height: 56px;
            background: var(--primary-cyan);
            border-radius: 4px;
            margin: 0 auto var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--bg-black);
        }

        .ability-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: var(--spacing-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ability-cooldown {
            font-size: 11px;
            color: var(--text-dim);
        }

        /* Ultimate Slot */
        .ultimate-slot {
            border-color: var(--primary-orange);
            background: rgba(255, 107, 0, 0.1);
        }

        .ultimate-slot .ability-icon {
            background: var(--primary-orange);
            width: 64px;
            height: 64px;
            font-size: 32px;
        }

        /* Passive Abilities */
        .passive-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .passive-slot {
            background: var(--bg-medium);
            border: 2px solid var(--border-gray);
            border-radius: 4px;
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        /* Aura Slot Special Styling */
        .aura-slot {
            border-color: var(--secondary-purple);
            background: rgba(128, 0, 255, 0.1);
        }

        .aura-slot .passive-icon {
            background: var(--secondary-purple);
        }

        .passive-icon {
            width: 48px;
            height: 48px;
            background: var(--border-gray);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-bright);
        }

        .passive-info {
            flex: 1;
        }

        .passive-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .passive-desc {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* Class Passives Grid */
        .passive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .passive-item {
            background: var(--bg-medium);
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: var(--spacing-sm);
            font-size: 12px;
        }

        .passive-item-name {
            color: var(--secondary-purple);
            font-weight: 600;
            margin-right: var(--spacing-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .passive-item-desc {
            color: var(--text-normal);
        }

        /* Equipment Preview */
        .equipment-preview {
            background: var(--bg-medium);
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .equipment-preview .card-header {
            margin-bottom: var(--spacing-md);
        }

        .equipment-preview .card-title {
            font-size: 16px;
            color: var(--primary-cyan);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .equipment-preview .card-accent {
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-cyan) 0%, transparent 100%);
            margin-bottom: var(--spacing-md);
        }

        .equipment-grid {
            display: grid !important;
            grid-template-columns: 104px 104px 296px !important;
            grid-template-rows: 104px 104px 104px !important;
            gap: 4px !important;
            max-width: 520px !important;
            width: 520px !important;
            box-sizing: border-box;
            margin-top: var(--spacing-md);
        }

        .equipment-slot {
            width: 104px;
            height: 104px;
            background: var(--bg-dark);
            border: 2px solid var(--border-gray);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-dim);
            flex-direction: column;
            padding: 4px;
            position: relative;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .equipment-slot[data-slot="primary"],
        .equipment-slot[data-slot="secondary"] {
            width: 296px;
            height: 104px;
            grid-row: span 1;
        }

        .equipment-slot.equipped {
            border: 2px solid var(--border-gray);
        }

        .equipment-slot[data-rarity="common"] { border-color: #999; }
        .equipment-slot[data-rarity="uncommon"] { border-color: #00ff00; }
        .equipment-slot[data-rarity="rare"] { border-color: #0099ff; }
        .equipment-slot[data-rarity="epic"] { border-color: #cc00ff; }
        .equipment-slot[data-rarity="legendary"] { border-color: #ff9900; }
        .equipment-slot[data-rarity="exotic"] { border-color: #ff0099; }

        .equipped-item {
            width: 100%;
            height: 100%;
            position: relative;
            border-radius: 2px;
            overflow: hidden;
        }

        .item-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-icon-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .power-rating {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.8);
            color: #ffcc00;
            font-size: 10px;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 2px;
            min-width: 16px;
            text-align: center;
        }

        .equipment-placeholder {
            color: var(--text-dim);
            font-size: 10px;
            text-align: center;
            line-height: 1.2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            word-wrap: break-word;
            max-width: 100%;
            padding: 4px;
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-xl);
        }

        .btn-activate {
            background: var(--primary-cyan);
            color: var(--bg-black);
            border: 1px solid var(--primary-cyan);
        }

        .btn-activate:hover {
            background: transparent;
            color: var(--primary-cyan);
        }

        .btn-share {
            background: transparent;
            color: var(--text-normal);
            border: 1px solid var(--border-gray);
        }

        .btn-share:hover {
            background: var(--bg-light);
            color: var(--text-bright);
            border-color: var(--text-bright);
        }
        
        /* Empty Slot Styling */
        .empty-slot {
            border-style: dashed !important;
            opacity: 0.6;
            cursor: pointer;
        }
        
        .empty-slot:hover {
            opacity: 1;
            border-color: var(--primary-cyan) !important;
        }
        
        .empty-slot .ability-icon {
            font-size: 32px;
            color: var(--text-dim);
        }
        
        /* Skill Selector Modal */
        .skill-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .skill-selector-content {
            background: var(--bg-dark);
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            padding: var(--spacing-lg);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .skill-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-gray);
        }
        
        .skill-selector-header h3 {
            color: var(--primary-cyan);
            margin: 0;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .skill-selector-header button {
            background: none;
            border: 1px solid var(--border-gray);
            color: var(--text-normal);
            font-size: 20px;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .skill-selector-header button:hover {
            background: var(--danger-red);
            color: white;
        }
        
        .skill-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--spacing-md);
        }
        
        .skill-selector-item {
            background: var(--bg-medium);
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            padding: var(--spacing-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .skill-selector-item:hover {
            border-color: var(--primary-cyan);
            background: var(--bg-light);
            transform: translateY(-2px);
        }
        
        .skill-selector-item .skill-icon {
            font-size: 36px;
            margin-bottom: var(--spacing-sm);
        }
        
        .skill-selector-item .skill-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: var(--spacing-xs);
        }
        
        .skill-selector-item .skill-rank {
            font-size: 10px;
            color: var(--text-dim);
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="navbar">
        <div class="nav-brand">
            <div class="nav-logo"></div>
            <div>
                <div class="nav-username">AGENT RECON-7</div>
                <div class="nav-level">LEVEL 60 • PARAGON 40</div>
            </div>
        </div>
        <div class="nav-menu">
            <a href="game/dashboard.html" class="nav-item">CHARACTER</a>
            <a href="inventory.html" class="nav-item">INVENTORY</a>
            <a href="missions.html" class="nav-item">MISSIONS</a>
            <a href="skills.html" class="nav-item">SKILLS</a>
            <a href="loadouts.html" class="nav-item active">LOADOUTS</a>
            <a href="build-planner.html" class="nav-item">BUILD PLANNER</a>
            <a href="marketplace.html" class="nav-item">MARKET</a>
            <a href="crafting.html" class="nav-item">CRAFTING</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="page-container">
        <div class="page-header">
            <h1 class="page-title">LOADOUT MANAGEMENT</h1>
        </div>

        <div class="loadout-container">
            <!-- Loadout Preset Tabs -->
            <div class="loadout-tabs">
                <button class="loadout-tab active activated" data-loadout="1">
                    Boss Killer
                </button>
                <button class="loadout-tab" data-loadout="2">
                    Mob Clear
                </button>
                <button class="loadout-tab" data-loadout="3">
                    PvP Duelist
                </button>
                <button class="loadout-tab" data-loadout="4">
                    Support
                </button>
                <button class="loadout-tab empty" data-loadout="5">
                    + Empty Slot
                </button>
            </div>

            <!-- Main Loadout Card -->
            <div class="loadout-card">
                <div class="loadout-header">
                    <h1 class="loadout-title">Current Build</h1>
                    <button class="edit-button" onclick="window.location.href='edit-loadout.html'">Edit Loadout</button>
                </div>

                <!-- Ultimate Ability -->
                <div class="ability-section">
                    <h3 class="section-title">Ultimate Ability</h3>
                    <div class="abilities-grid" id="ultimate-abilities">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Active Abilities -->
                <div class="ability-section">
                    <h3 class="section-title">Active Abilities</h3>
                    <div class="abilities-grid" id="active-abilities">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Passive Abilities -->
                <div class="passive-section" id="key-passives">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Aura Section -->
                <div class="ability-section">
                    <h3 class="section-title">Active Auras</h3>
                    <div class="passive-section" id="active-auras">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Class Passives -->
                <div class="ability-section" style="margin-top: var(--spacing-xl);">
                    <h3 class="section-title">Class Passives</h3>
                    <div class="passive-grid" id="class-passives">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Equipment Preview -->
                <div class="equipment-preview">
                    <div class="card-header">
                        <h3 class="card-title">Equipped Items</h3>
                    </div>
                    <div class="card-accent"></div>
                    
                    <div class="equipment-grid">
                        <!-- Row 1: Head, Shoulders | Primary Weapon -->
                        <div class="equipment-slot" data-slot="head">
                            <div class="equipment-placeholder">Head</div>
                        </div>
                        <div class="equipment-slot" data-slot="shoulders">
                            <div class="equipment-placeholder">Shoulders</div>
                        </div>
                        <div class="equipment-slot" data-slot="primary">
                            <div class="equipment-placeholder">Primary</div>
                        </div>
                        
                        <!-- Row 2: Chest, Back | Secondary Weapon -->
                        <div class="equipment-slot" data-slot="chest">
                            <div class="equipment-placeholder">Chest</div>
                        </div>
                        <div class="equipment-slot" data-slot="back">
                            <div class="equipment-placeholder">Back</div>
                        </div>
                        <div class="equipment-slot" data-slot="secondary">
                            <div class="equipment-placeholder">Secondary</div>
                        </div>
                        
                        <!-- Row 3: Gloves, Legs -->
                        <div class="equipment-slot" data-slot="gloves">
                            <div class="equipment-placeholder">Gloves</div>
                        </div>
                        <div class="equipment-slot" data-slot="legs">
                            <div class="equipment-placeholder">Legs</div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-activate">Activate Loadout</button>
                    <button class="btn btn-share">Share Loadout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="padding: 20px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #333; margin-top: 40px;">
        <a href="changelog.html" style="color: #666; text-decoration: none; border-bottom: 1px dotted #666;">CHANGELOG</a> • 
        <a href="specs/index.html" style="color: #666; text-decoration: none; border-bottom: 1px dotted #666;">SPECS</a> • 
        <a href="tuning/index.html" style="color: #666; text-decoration: none; border-bottom: 1px dotted #666;">TUNING</a> • 
        <a href="admin/index.html" style="color: #666; text-decoration: none; border-bottom: 1px dotted #666;">ADMIN</a> • 
        <a href="sim/index.html" style="color: #666; text-decoration: none; border-bottom: 1px dotted #666;">SIMULATOR</a> • 
        LAST UPDATED: 2025-08-17 CST • LOADOUTS: Equipment integration and combat simulator access
    </footer>

    <script src="assets/js/api-client-v4.js"></script>
    <script src="assets/js/character-header.js"></script>
    <script src="assets/js/tooltips.js"></script>
    <script src="assets/js/data-manager.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/navigation.js"></script>
    <script>
        // Equipment integration for loadouts using backend API
        async function loadEquippedItems() {
            try {
                if (!window.CourierAPI) {
                    console.error('CourierAPI not available');
                    return;
                }

                // Initialize tooltips
                if (window.CourierTooltips) {
                    window.CourierTooltips.init();
                }

                // Get equipped items from backend API
                const response = await window.CourierAPI.getEquipped();
                const equippedItems = response.equipped || {};
                
                console.log('Loaded equipped items for loadouts:', equippedItems);
                
                // Define slot order for the equipment grid (matching dashboard layout)
                const slots = ['head', 'shoulders', 'primary', 'chest', 'back', 'secondary', 'gloves', 'legs'];
                
                slots.forEach(slot => {
                    const slotElement = document.querySelector(`[data-slot="${slot}"]`);
                    if (!slotElement) return;

                    const equippedItem = equippedItems[slot];
                    
                    if (equippedItem && equippedItem.id) {
                        // Show equipped item with same styling as inventory
                        slotElement.classList.add('equipped');
                        slotElement.dataset.rarity = equippedItem.rarity;
                        
                        // Fix icon path 
                        let iconPath = equippedItem.icon;
                        
                        // Add cache-busting parameter
                        const cacheBuster = Date.now();
                        const iconPathWithCache = `${iconPath}?v=${cacheBuster}`;
                        
                        slotElement.innerHTML = `
                            <div class="equipped-item rarity-${equippedItem.rarity}">
                                <div class="item-icon">
                                    <img src="${iconPathWithCache}" alt="${equippedItem.name}" class="item-icon-img" />
                                </div>
                                <div class="power-rating">${equippedItem.power_cost || 0}</div>
                                <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; font-size: 8px; padding: 2px; text-align: center;">${equippedItem.name}</div>
                            </div>
                        `;

                        // Add tooltip support
                        slotElement.addEventListener('mouseenter', (e) => {
                            if (window.CourierTooltips) {
                                const tooltipItem = transformItemForTooltip(equippedItem);
                                window.CourierTooltips.showTooltip(e, tooltipItem);
                            }
                        });

                        slotElement.addEventListener('mouseleave', () => {
                            if (window.CourierTooltips) {
                                window.CourierTooltips.hideTooltip();
                            }
                        });
                        
                        // Add click functionality for weapons to open detail page
                        if (equippedItem.type === 'weapon') {
                            slotElement.style.cursor = 'pointer';
                            slotElement.addEventListener('click', (e) => {
                                window.location.href = `weapon-detail.html?id=${equippedItem.id}`;
                            });
                        }
                    } else {
                        // Show empty slot placeholder
                        slotElement.classList.remove('equipped');
                        slotElement.removeAttribute('data-rarity');
                        slotElement.innerHTML = `<div class="equipment-placeholder">${slot.charAt(0).toUpperCase() + slot.slice(1)}</div>`;
                    }
                });
                
            } catch (error) {
                console.error('Error loading equipped items:', error);
            }
        }

        // Transform database format to tooltip format (same as inventory)
        function transformItemForTooltip(item) {
            const tooltipItem = { ...item };
            
            // Convert snake_case to camelCase for tooltip system
            tooltipItem.powerCost = item.power_cost;
            tooltipItem.itemSubtype = item.item_subtype;
            tooltipItem.weaponType = item.weapon_type;
            
            // Convert separate damage fields to damage object
            if (item.damage_min && item.damage_max) {
                tooltipItem.damage = {
                    min: item.damage_min,
                    max: item.damage_max
                };
                tooltipItem.damageMin = item.damage_min;
                tooltipItem.damageMax = item.damage_max;
            }
            
            // Convert weapon attribute snake_case to camelCase
            if (item.type === 'weapon') {
                tooltipItem.fireRate = item.fire_rate;
                tooltipItem.magazineSize = item.magazine_size;
                tooltipItem.ammoCapacity = item.ammo_capacity;
                tooltipItem.reloadSpeed = item.reload_speed;
                tooltipItem.adsSpeed = item.ads_speed;
                tooltipItem.rangeEffective = item.range_effective;
                tooltipItem.rangeMax = item.range_max;
                tooltipItem.handling = item.handling;
                tooltipItem.accuracy = item.accuracy;
                tooltipItem.stability = item.stability;
                tooltipItem.recoil = item.recoil;
                
                // Handle advanced stats for modified weapons
                if (item.damage_percent || item.crit_chance_percent || 
                    item.fire_damage_flat || item.fire_damage_percent ||
                    item.ice_damage_flat || item.ice_damage_percent ||
                    item.electric_damage_flat || item.electric_damage_percent ||
                    item.poison_damage_flat || item.poison_damage_percent ||
                    item.armor_penetration || item.damage_multiplier_vs_elites ||
                    item.damage_multiplier_vs_bosses) {
                    
                    tooltipItem.advanced_stats = {
                        damage_percent: item.damage_percent || 0,
                        crit_chance_percent: item.crit_chance_percent || 0,
                        fire_damage_flat: item.fire_damage_flat || 0,
                        fire_damage_percent: item.fire_damage_percent || 0,
                        ice_damage_flat: item.ice_damage_flat || 0,
                        ice_damage_percent: item.ice_damage_percent || 0,
                        electric_damage_flat: item.electric_damage_flat || 0,
                        electric_damage_percent: item.electric_damage_percent || 0,
                        poison_damage_flat: item.poison_damage_flat || 0,
                        poison_damage_percent: item.poison_damage_percent || 0,
                        armor_penetration: item.armor_penetration || 0,
                        damage_multiplier_vs_elites: item.damage_multiplier_vs_elites || 0,
                        damage_multiplier_vs_bosses: item.damage_multiplier_vs_bosses || 0
                    };
                }
            }
            
            return tooltipItem;
        }

        // Initialize the loadouts page
        async function initializeLoadouts() {
            try {
                console.log('Initializing loadouts page...');
                await loadEquippedItems();
                console.log('Loadouts page initialized successfully');
            } catch (error) {
                console.error('Error initializing loadouts page:', error);
            }
        }

        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', initializeLoadouts);
    </script>

    <script>
        // Initialize loadout system with skill data
        let skillsDatabase = {};
        let currentSkillPoints = {
            available: 15,
            total: 60,
            invested: {}
        };
        
        // Load character skill data from API
        async function loadCurrentSkillInvestments() {
            try {
                console.log('Loading character skill data...');
                
                // Initialize with empty data (no skills invested by default)
                currentSkillPoints.invested = {
                    class: {},
                    fire: {},
                    ice: {},
                    electric: {},
                    earth: {},
                    nature: {}
                };
                
                if (!window.CourierAPI) {
                    console.error('CourierAPI not available, using empty skill data');
                    currentSkillPoints.available = 1;
                    currentSkillPoints.total = 1;
                    return;
                }
                
                // Load active character data
                const characterResponse = await window.CourierAPI.loadActiveCharacter();
                if (characterResponse.success && characterResponse.character) {
                    const character = characterResponse.character;
                    
                    // Set skill points based on character level
                    currentSkillPoints.available = character.skill_points_available || 1;
                    currentSkillPoints.total = character.level || 1;
                    
                    console.log(`Character Level ${character.level}: ${currentSkillPoints.available}/${currentSkillPoints.total} skill points`);
                    
                    // TODO: Load actual skill investments from character_skills table
                    // For now, character has no skills invested (level 1)
                    console.log('Character skill investments loaded (empty for level 1 character)');
                } else {
                    console.error('Failed to load character data, using defaults');
                    currentSkillPoints.available = 1;
                    currentSkillPoints.total = 1;
                }
            } catch (error) {
                console.error('Error loading character skill data:', error);
                // Use safe defaults for level 1 character
                currentSkillPoints.available = 1;
                currentSkillPoints.total = 1;
                currentSkillPoints.invested = { class: {}, fire: {}, ice: {}, electric: {}, earth: {}, nature: {} };
            }
        }

        // Load skills database
        async function loadSkillsData() {
            try {
                const response = await fetch('assets/data/skills.json?v=22');
                if (response.ok) {
                    skillsDatabase = await response.json();
                    console.log('Skills data loaded for loadouts');
                    await loadCurrentSkillInvestments();
                    populateLoadout();
                    console.log('Loadout populated with real character skill data');
                } else {
                    console.error('Failed to load skills data');
                }
            } catch (error) {
                console.error('Error loading skills data:', error);
            }
        }

        // Populate loadout based on invested skills
        function populateLoadout() {
            populateUltimateAbilities();
            populateActiveAbilities();
            populateKeyPassives();
            populateAuras();
            populateClassPassives();
        }

        function populateUltimateAbilities() {
            const container = document.getElementById('ultimate-abilities');
            if (!container) return;

            // Dynamically find all ultimate skills (tier 6) that the player has invested in
            const availableUltimateSkills = [];
            
            // Check class tree ultimates
            if (skillsDatabase.class) {
                Object.keys(skillsDatabase.class).forEach(skillId => {
                    const skill = skillsDatabase.class[skillId];
                    const invested = currentSkillPoints.invested.class?.[skillId] || 0;
                    if (skill.tier === 6 && invested > 0) {
                        availableUltimateSkills.push({
                            id: skillId,
                            skill: skill,
                            invested: invested,
                            tree: 'class'
                        });
                    }
                });
            }
            
            // Check elemental tree ultimates (capstone skills)
            ['fire', 'ice', 'electric', 'earth', 'nature'].forEach(element => {
                if (skillsDatabase[element]) {
                    Object.keys(skillsDatabase[element]).forEach(skillId => {
                        const skill = skillsDatabase[element][skillId];
                        const invested = currentSkillPoints.invested[element]?.[skillId] || 0;
                        // Look for capstone skills (typically 1 max point and high requirements)
                        if (skill.maxPoints === 1 && invested > 0 && skill.requirements && skill.requirements.includes('15 points')) {
                            availableUltimateSkills.push({
                                id: skillId,
                                skill: skill,
                                invested: invested,
                                tree: element
                            });
                        }
                    });
                }
            });

            let html = '';
            let hasUltimate = false;

            availableUltimateSkills.forEach(ultimate => {
                const iconMap = {
                    // Class ultimates
                    'high-noon': '🌅',
                    'dead-mans-hand': '🃏', 
                    'perfect-shot': '🎯',
                    'legendary-outlaw': '🤠',
                    // Elemental ultimates
                    'pyroclasm-lord': '🔥',
                    'cryogenic-master': '❄️',
                    'storm-god': '⚡',
                    'earthquake-god': '🌍',
                    'plague-god': '🌿'
                };

                html += `
                    <div class="ability-slot ultimate-slot" data-skill="${ultimate.id}">
                        <div class="ability-icon">${ultimate.skill.icon || iconMap[ultimate.id] || '✨'}</div>
                        <div class="ability-name">${ultimate.skill.name}</div>
                        <div class="ability-cooldown">${ultimate.tree.toUpperCase()} • Rank ${ultimate.invested}</div>
                    </div>
                `;
                hasUltimate = true;
            });

            if (!hasUltimate) {
                // Show empty slot if no ultimates are available
                html = `
                    <div class="ability-slot ultimate-slot empty-slot" onclick="showSkillSelector('ultimate')">
                        <div class="ability-icon">+</div>
                        <div class="ability-name">Add Ultimate</div>
                        <div class="ability-cooldown">Click to assign</div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Store current loadout assignment
        let currentLoadoutSlots = {
            ultimate: null,
            actives: [null, null, null, null, null, null]
        };
        
        function populateActiveAbilities() {
            const container = document.getElementById('active-abilities');
            if (!container) return;

            const activeSkills = ['fan-hammer', 'ricochet-roulette', 'gunslinger-focus', 'all-in', 'bullet-time', 'vanish'];
            let html = '';
            
            const iconMap = {
                'fan-hammer': '🌪️',
                'ricochet-roulette': '🪃',
                'gunslinger-focus': '🎲',
                'all-in': '🃏',
                'bullet-time': '⏰',
                'vanish': '👻'
            };

            const cooldownMap = {
                'fan-hammer': '25s',
                'ricochet-roulette': '20s', 
                'gunslinger-focus': '25s',
                'all-in': '35s',
                'bullet-time': '40s',
                'vanish': '35s'
            };

            // Create 6 slots, either with assigned skills or empty
            for (let i = 0; i < 6; i++) {
                const assignedSkill = currentLoadoutSlots.actives[i];
                
                if (assignedSkill && currentSkillPoints.invested.class[assignedSkill] > 0) {
                    const skill = skillsDatabase.class?.[assignedSkill];
                    const invested = currentSkillPoints.invested.class[assignedSkill];
                    const currentEffect = skill.effects[invested - 1] || skill.description;
                    
                    html += `
                        <div class="ability-slot" data-skill="${assignedSkill}" data-slot="${i}" title="${currentEffect}" onclick="removeSkillFromSlot('active', ${i})">
                            <div class="ability-icon">${iconMap[assignedSkill]}</div>
                            <div class="ability-name">${skill.name}</div>
                            <div class="ability-cooldown">${cooldownMap[assignedSkill]} • Rank ${invested}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="ability-slot empty-slot" data-slot="${i}" onclick="showSkillSelector('active', ${i})">
                            <div class="ability-icon">+</div>
                            <div class="ability-name">Add Skill</div>
                            <div class="ability-cooldown">Click to assign</div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
        }

        function populateKeyPassives() {
            const container = document.getElementById('key-passives');
            if (!container) return;

            const keyPassives = ['sniper-specialist', 'handgun-specialist'];
            let html = '';

            keyPassives.forEach(skillId => {
                const invested = currentSkillPoints.invested.class[skillId] || 0;
                if (invested > 0) {
                    const skill = skillsDatabase.class?.[skillId];
                    if (skill) {
                        const iconMap = {
                            'sniper-specialist': '🔍',
                            'handgun-specialist': '🔫'
                        };

                        const descMap = {
                            'sniper-specialist': 'First shot from cover: 200% damage',
                            'handgun-specialist': 'No recoil, +25% accuracy while moving'
                        };

                        html += `
                            <div class="passive-slot">
                                <div class="passive-icon">${iconMap[skillId]}</div>
                                <div class="passive-info">
                                    <div class="passive-name">${skill.name}</div>
                                    <div class="passive-desc">${descMap[skillId]}</div>
                                </div>
                            </div>
                        `;
                    }
                }
            });

            container.innerHTML = html;
        }

        function populateAuras() {
            const container = document.getElementById('active-auras');
            if (!container) return;

            let html = '';
            let auraCount = 0;

            // Elemental aura skills - skills that provide continuous passive effects
            const auraSkills = {
                fire: ['flame-weapon', 'heat-resistance', 'combustion-mastery'],
                ice: ['frost-armor', 'ice-mastery', 'cold-resistance'],
                electric: ['static-field', 'lightning-mastery', 'shock-resistance'],
                earth: ['stone-skin', 'earth-mastery', 'ground-resistance'],
                nature: ['healing-aura', 'nature-mastery', 'poison-resistance']
            };

            const elementalIcons = {
                fire: '🔥',
                ice: '❄️',
                electric: '⚡',
                earth: '🌍',
                nature: '🌿'
            };

            Object.keys(auraSkills).forEach(tree => {
                auraSkills[tree].forEach(skillId => {
                    const invested = currentSkillPoints.invested[tree]?.[skillId] || 0;
                    if (invested > 0) {
                        const skill = skillsDatabase[tree]?.[skillId];
                        if (skill) {
                            const currentEffect = skill.effects[invested - 1] || skill.description;
                            
                            html += `
                                <div class="passive-slot aura-slot">
                                    <div class="passive-icon">${elementalIcons[tree]}</div>
                                    <div class="passive-info">
                                        <div class="passive-name">${skill.name} (${invested}/${skill.maxPoints})</div>
                                        <div class="passive-desc">${currentEffect}</div>
                                    </div>
                                </div>
                            `;
                            auraCount++;
                        }
                    }
                });
            });

            if (auraCount === 0) {
                html = `
                    <div class="passive-slot" style="opacity: 0.5;">
                        <div class="passive-icon">🌀</div>
                        <div class="passive-info">
                            <div class="passive-name">No active auras</div>
                            <div class="passive-desc">Invest in elemental skills to gain passive aura effects</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function populateClassPassives() {
            const container = document.getElementById('class-passives');
            if (!container) return;

            let html = '';
            let passiveCount = 0;

            // Active skills that should not appear in the passives list
            const activeSkills = ['fan-hammer', 'ricochet-roulette', 'gunslinger-focus', 'all-in', 'bullet-time', 'vanish', 'high-noon', 'dead-mans-hand', 'perfect-shot'];

            Object.keys(currentSkillPoints.invested.class).forEach(skillId => {
                const invested = currentSkillPoints.invested.class[skillId];
                if (invested > 0 && !activeSkills.includes(skillId)) {
                    const skill = skillsDatabase.class?.[skillId];
                    if (skill && skill.tier <= 5) { // Don't show ultimates here
                        const currentEffect = skill.effects[invested - 1];
                        if (currentEffect) {
                            html += `
                                <div class="passive-item">
                                    <span class="passive-item-name">${skill.name} (${invested}/${skill.maxPoints}):</span>
                                    <span class="passive-item-desc">${currentEffect}</span>
                                </div>
                            `;
                            passiveCount++;
                        }
                    }
                }
            });

            // Add elemental passives (all elemental skills are typically passive auras or effects)
            const elementalTrees = ['fire', 'ice', 'electric', 'earth', 'nature'];
            elementalTrees.forEach(tree => {
                Object.keys(currentSkillPoints.invested[tree] || {}).forEach(skillId => {
                    const invested = currentSkillPoints.invested[tree][skillId];
                    if (invested > 0) {
                        const skill = skillsDatabase[tree]?.[skillId];
                        if (skill) {
                            const currentEffect = skill.effects[invested - 1];
                            if (currentEffect) {
                                html += `
                                    <div class="passive-item">
                                        <span class="passive-item-name">${skill.name} (${invested}/${skill.maxPoints}):</span>
                                        <span class="passive-item-desc">${currentEffect}</span>
                                    </div>
                                `;
                                passiveCount++;
                            }
                        }
                    }
                });
            });

            if (passiveCount === 0) {
                html = `
                    <div class="passive-item" style="opacity: 0.5;">
                        <span class="passive-item-name">No passive skills invested</span>
                        <span class="passive-item-desc">Invest skill points to see passive effects here</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Show skill selector modal
        function showSkillSelector(slotType, slotIndex = null) {
            const availableSkills = getAvailableSkillsForSlot(slotType);
            
            if (availableSkills.length === 0) {
                alert('No learned skills available for this slot type. Invest skill points first!');
                return;
            }
            
            let html = `
                <div class="skill-selector-modal" id="skillSelectorModal">
                    <div class="skill-selector-content">
                        <div class="skill-selector-header">
                            <h3>Select ${slotType === 'ultimate' ? 'Ultimate' : 'Active'} Skill</h3>
                            <button onclick="closeSkillSelector()">×</button>
                        </div>
                        <div class="skill-selector-grid">
            `;
            
            availableSkills.forEach(skillId => {
                const skill = skillsDatabase.class[skillId];
                const invested = currentSkillPoints.invested.class[skillId];
                const iconMap = {
                    'high-noon': '🌅', 'dead-mans-hand': '🃏', 'perfect-shot': '🎯',
                    'fan-hammer': '🌪️', 'ricochet-roulette': '🪃', 'gunslinger-focus': '🎲',
                    'all-in': '🃏', 'bullet-time': '⏰', 'vanish': '👻'
                };
                
                html += `
                    <div class="skill-selector-item" onclick="assignSkillToSlot('${skillId}', '${slotType}', ${slotIndex})">
                        <div class="skill-icon">${iconMap[skillId] || '⚡'}</div>
                        <div class="skill-name">${skill.name}</div>
                        <div class="skill-rank">Rank ${invested}</div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function getAvailableSkillsForSlot(slotType) {
            if (slotType === 'ultimate') {
                // Dynamically get all ultimate skills the player has learned
                const availableUltimateSkills = [];
                
                // Check class tree ultimates (tier 6)
                if (skillsDatabase.class) {
                    Object.keys(skillsDatabase.class).forEach(skillId => {
                        const skill = skillsDatabase.class[skillId];
                        const invested = currentSkillPoints.invested.class?.[skillId] || 0;
                        if (skill.tier === 6 && invested > 0) {
                            availableUltimateSkills.push(skillId);
                        }
                    });
                }
                
                // Check elemental tree ultimates (capstone skills)
                ['fire', 'ice', 'electric', 'earth', 'nature'].forEach(element => {
                    if (skillsDatabase[element]) {
                        Object.keys(skillsDatabase[element]).forEach(skillId => {
                            const skill = skillsDatabase[element][skillId];
                            const invested = currentSkillPoints.invested[element]?.[skillId] || 0;
                            // Look for capstone skills (typically 1 max point and high requirements)
                            if (skill.maxPoints === 1 && invested > 0 && skill.requirements && skill.requirements.includes('15 points')) {
                                availableUltimateSkills.push(skillId);
                            }
                        });
                    }
                });
                
                return availableUltimateSkills;
            } else {
                // For active skills, dynamically find skills with abilities/cooldowns
                const activeSkills = [];
                
                if (skillsDatabase.class) {
                    Object.keys(skillsDatabase.class).forEach(skillId => {
                        const skill = skillsDatabase.class[skillId];
                        const invested = currentSkillPoints.invested.class?.[skillId] || 0;
                        // Look for active skills (skills with cooldowns mentioned in effects)
                        if (invested > 0 && skill.effects && skill.effects.some(effect => effect.includes('cooldown'))) {
                            activeSkills.push(skillId);
                        }
                    });
                }
                
                return activeSkills;
            }
        }
        
        function assignSkillToSlot(skillId, slotType, slotIndex) {
            if (slotType === 'ultimate') {
                currentLoadoutSlots.ultimate = skillId;
            } else if (slotType === 'active') {
                currentLoadoutSlots.actives[slotIndex] = skillId;
            }
            
            closeSkillSelector();
            populateLoadout();
        }
        
        function removeSkillFromSlot(slotType, slotIndex) {
            if (slotType === 'ultimate') {
                currentLoadoutSlots.ultimate = null;
            } else if (slotType === 'active') {
                currentLoadoutSlots.actives[slotIndex] = null;
            }
            
            populateLoadout();
        }
        
        function closeSkillSelector() {
            const modal = document.getElementById('skillSelectorModal');
            if (modal) {
                modal.remove();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Loadout page DOMContentLoaded - initializing...');
            try {
                loadEquippedItems();
                loadSkillsData();
                console.log('Loadout page initialization complete');
            } catch (error) {
                console.error('Error during loadout page initialization:', error);
            }
        });
    </script>
    <script>
        // Loadout switching functionality
        const loadoutTabs = document.querySelectorAll('.loadout-tab');
        const loadoutTitle = document.querySelector('.loadout-title');
        
        // Predefined loadout builds - these will copy from current purchased skills
        const predefinedLoadouts = {
            'current': {
                name: 'Current Build',
                skills: null // Will be set to actual purchased skills
            }
        };

        loadoutTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const loadoutId = this.dataset.loadout;
                
                // Update active state
                loadoutTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Handle loadout selection - all tabs now show current purchased skills
                switch(loadoutId) {
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                        loadoutTitle.textContent = 'Current Build';
                        // Skills are already loaded from data manager/localStorage
                        populateLoadout();
                        break;
                    case '5': 
                        window.location.href = 'edit-loadout.html';
                        return;
                }
            });
        });

        // Save current loadout
        function saveCurrentLoadout(loadoutName) {
            const loadoutData = {
                name: loadoutName,
                skillInvestments: { ...currentSkillPoints.invested },
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem(`courier-loadout-${loadoutName.toLowerCase().replace(/\s+/g, '-')}`, JSON.stringify(loadoutData));
                console.log(`Saved loadout: ${loadoutName}`);
                return true;
            } catch (error) {
                console.error('Error saving loadout:', error);
                return false;
            }
        }
        
        // Load and apply a saved loadout
        function loadSavedLoadout(loadoutName) {
            try {
                const loadoutData = localStorage.getItem(`courier-loadout-${loadoutName.toLowerCase().replace(/\s+/g, '-')}`);
                if (loadoutData) {
                    const parsed = JSON.parse(loadoutData);
                    currentSkillPoints.invested = parsed.skillInvestments || { class: {}, fire: {}, ice: {}, electric: {}, earth: {}, nature: {} };
                    
                    // Update localStorage with new skill investments
                    const savedSkills = localStorage.getItem('courier-skill-investments') || '{}';
                    const skillData = JSON.parse(savedSkills);
                    Object.keys(currentSkillPoints.invested).forEach(tree => {
                        skillData[tree] = currentSkillPoints.invested[tree];
                    });
                    localStorage.setItem('courier-skill-investments', JSON.stringify(skillData));
                    
                    populateLoadout();
                    console.log(`Loaded loadout: ${loadoutName}`);
                    return true;
                }
            } catch (error) {
                console.error('Error loading loadout:', error);
            }
            return false;
        }
        
        // Activate loadout button using data manager
        document.querySelector('.btn-activate').addEventListener('click', async function() {
            const activeTab = document.querySelector('.loadout-tab.active');
            const loadoutId = activeTab?.dataset.loadout;
            let success = false;
            
            if (window.CourierData && loadoutId) {
                // Map loadout numbers to IDs
                const loadoutIdMap = {
                    '1': 'boss-killer',
                    '2': 'mob-clear', 
                    '3': 'pvp-duelist',
                    '4': 'support'
                };
                
                const loadoutKey = loadoutIdMap[loadoutId];
                if (loadoutKey) {
                    success = window.CourierData.activateLoadout(loadoutKey);
                    
                    if (success) {
                        // Reload current skill investments to show the activated loadout
                        await loadCurrentSkillInvestments();
                        populateLoadout();
                    }
                }
            } else {
                // Fallback to old method
                const currentLoadoutName = document.querySelector('.loadout-title').textContent;
                success = loadSavedLoadout(currentLoadoutName);
            }
            
            if (success) {
                // Remove activated state from all tabs
                loadoutTabs.forEach(tab => tab.classList.remove('activated'));
                
                // Add activated state to currently selected tab
                if (activeTab) {
                    activeTab.classList.add('activated');
                }
                
                this.textContent = 'Activated!';
                this.style.background = 'var(--primary-orange)';
                setTimeout(() => {
                    this.textContent = 'Activate Loadout';
                    this.style.background = 'var(--primary-cyan)';
                }, 2000);
            } else {
                this.textContent = 'Error!';
                this.style.background = 'var(--danger-red)';
                setTimeout(() => {
                    this.textContent = 'Activate Loadout';
                    this.style.background = 'var(--primary-cyan)';
                }, 2000);
            }
        });
        
        // Auto-save current build as current loadout
        function autoSaveCurrentLoadout() {
            const currentLoadoutName = document.querySelector('.loadout-title').textContent;
            saveCurrentLoadout(currentLoadoutName);
        }
        
        // Auto-save when skills change (check every 5 seconds)
        setInterval(() => {
            if (Object.keys(currentSkillPoints.invested).length > 0) {
                autoSaveCurrentLoadout();
            }
        }, 5000);
    </script>
</body>
</html>