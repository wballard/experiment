<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Dashboard - Courier</title>
    <link rel="stylesheet" href="assets/css/design-system.css?v=13">
    <link rel="stylesheet" href="assets/css/main.css?v=13">
    <!-- REMOVED game.css to fix equipment display conflicts -->
    <link rel="stylesheet" href="assets/css/inventory.css?v=18">
    <style>
        /* WORKING STYLES FROM TEST WIDGET */
        .equipment-grid {
            display: grid !important;
            grid-template-columns: 104px 104px 296px !important;
            grid-template-rows: 104px 104px 104px !important;
            gap: 4px !important;
            max-width: 520px !important;
            width: 520px !important;
            box-sizing: border-box;
            margin-top: var(--spacing-md);
            background: transparent !important;
        }

        /* ARMOR SLOTS - 96px content + 2px buffer + 2px border each side = 104px total */
        .equipment-slot[data-slot="head"],
        .equipment-slot[data-slot="shoulders"], 
        .equipment-slot[data-slot="chest"],
        .equipment-slot[data-slot="gloves"],
        .equipment-slot[data-slot="back"],
        .equipment-slot[data-slot="legs"] {
            width: 104px !important;
            height: 104px !important;
            min-width: 104px !important;
            max-width: 104px !important;
            box-sizing: border-box;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: rgba(30, 30, 30, 0.8) !important;
            border: 2px solid var(--border-gray) !important;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 2px; /* 2px buffer inside container */
        }

        /* WEAPON SLOTS - 288x96px content + 2px buffer + 2px border each side = 296x104px total */
        .equipment-slot[data-slot="primary"],
        .equipment-slot[data-slot="secondary"] {
            width: 296px !important;
            height: 104px !important;
            min-width: 296px !important;
            max-width: 296px !important;
            box-sizing: border-box;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: rgba(30, 30, 30, 0.8) !important;
            border: 2px solid var(--border-gray) !important;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 2px; /* 2px buffer inside container */
        }

        /* GRID POSITIONING */
        .equipment-slot[data-slot="head"] { grid-column: 1; grid-row: 1; }
        .equipment-slot[data-slot="shoulders"] { grid-column: 2; grid-row: 1; }
        .equipment-slot[data-slot="primary"] { grid-column: 3; grid-row: 1; }
        .equipment-slot[data-slot="chest"] { grid-column: 1; grid-row: 2; }
        .equipment-slot[data-slot="back"] { grid-column: 2; grid-row: 2; }
        .equipment-slot[data-slot="secondary"] { grid-column: 3; grid-row: 2; }
        .equipment-slot[data-slot="gloves"] { grid-column: 1; grid-row: 3; }
        .equipment-slot[data-slot="legs"] { grid-column: 2; grid-row: 3; }

        /* ARMOR SLOT ICONS - 96x96px */
        .equipment-slot[data-slot="head"] .item-icon img,
        .equipment-slot[data-slot="head"] .item-icon-img,
        .equipment-slot[data-slot="shoulders"] .item-icon img,
        .equipment-slot[data-slot="shoulders"] .item-icon-img,
        .equipment-slot[data-slot="chest"] .item-icon img,
        .equipment-slot[data-slot="chest"] .item-icon-img,
        .equipment-slot[data-slot="gloves"] .item-icon img,
        .equipment-slot[data-slot="gloves"] .item-icon-img,
        .equipment-slot[data-slot="back"] .item-icon img,
        .equipment-slot[data-slot="back"] .item-icon-img,
        .equipment-slot[data-slot="legs"] .item-icon img,
        .equipment-slot[data-slot="legs"] .item-icon-img {
            width: 96px !important;
            height: 96px !important;
            object-fit: contain !important;
            object-position: center !important;
            max-width: 96px !important;
            max-height: 96px !important;
            display: block !important;
        }

        /* WEAPON SLOT ICONS - 288x96px */
        .equipment-slot[data-slot="primary"] .item-icon img,
        .equipment-slot[data-slot="primary"] .item-icon-img,
        .equipment-slot[data-slot="secondary"] .item-icon img,
        .equipment-slot[data-slot="secondary"] .item-icon-img {
            width: 288px !important;
            height: 96px !important;
            object-fit: cover !important;
            object-position: center !important;
            max-width: 288px !important;
            max-height: 96px !important;
            display: block !important;
        }

        .equipped-item {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            position: relative;
        }

        .equipped-item .item-icon {
            font-size: 24px;
            margin-bottom: 2px;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
        }

        /* Rarity backgrounds */
        .equipment-slot.equipped[data-rarity="common"],
        .equipped-item.rarity-common { 
            border-color: #666 !important;
            background: rgba(157, 157, 157, 0.3); 
        }
        .equipment-slot.equipped[data-rarity="uncommon"],
        .equipped-item.rarity-uncommon { 
            border-color: #666 !important;
            background: rgba(30, 255, 0, 0.3); 
        }
        .equipment-slot.equipped[data-rarity="rare"],
        .equipped-item.rarity-rare { 
            border-color: #666 !important;
            background: rgba(0, 112, 221, 0.3); 
        }
        .equipment-slot.equipped[data-rarity="epic"],
        .equipped-item.rarity-epic { 
            border-color: #666 !important;
            background: rgba(163, 53, 238, 0.3); 
        }
        .equipment-slot.equipped[data-rarity="legendary"],
        .equipped-item.rarity-legendary { 
            border-color: #666 !important;
            background: rgba(255, 128, 0, 0.3); 
        }
        .equipment-slot.equipped[data-rarity="mythic"],
        .equipped-item.rarity-mythic { 
            border-color: #666 !important;
            background: rgba(255, 0, 0, 0.3); 
        }
        .equipment-slot.equipped[data-rarity="primal"],
        .equipped-item.rarity-primal { 
            border-color: #666 !important;
            background: rgba(0, 255, 255, 0.3); 
        }

        .equipment-placeholder {
            color: var(--text-dim);
            font-size: 8px;
            text-align: center;
            line-height: 1.1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            word-wrap: break-word;
            max-width: 100%;
            padding: 2px;
        }

        /* Power Budget Progress Bar Styles */
        .power-progress-bar {
            width: 100% !important;
            height: 12px !important;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(20, 20, 20, 0.8) 100%) !important;
            border: 1px solid #444 !important;
            border-radius: 6px !important;
            overflow: hidden !important;
            position: relative !important;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3) !important;
            display: block !important;
        }

        .power-progress-fill {
            height: 100% !important;
            background: linear-gradient(135deg, #ff6600 0%, #ffaa44 50%, #ff8800 100%) !important;
            transition: width 0.8s ease !important;
            border-radius: 4px !important;
            position: relative !important;
            box-shadow: 0 0 8px rgba(255, 102, 0, 0.4) !important;
            display: block !important;
        }

        .power-progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            border-radius: 4px 4px 0 0;
        }

        .power-progress-fill.over-capacity {
            background: linear-gradient(135deg, #ff0000 0%, #ff4444 50%, #cc0000 100%) !important;
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.6) !important;
            animation: power-warning 1.5s ease-in-out infinite;
        }

        @keyframes power-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Dashboard layout override to match inventory page */
        .grid-2 {
            display: grid !important;
            grid-template-columns: 540px 1fr !important;
            gap: var(--spacing-lg) !important;
        }
        
        /* Override inline sidebar width styling */
        .sidebar {
            min-width: 520px !important;
            max-width: 540px !important;
            width: 540px !important;
        }

        /* Defense Stats Styles */
        .defense-stats,
        .offensive-stats {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .defense-category,
        .offensive-category {
            background: var(--bg-medium);
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: var(--spacing-md);
        }

        .defense-category-title,
        .offensive-category-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-gray);
            padding-bottom: var(--spacing-sm);
        }

        .defense-category-title {
            color: var(--primary-cyan);
        }

        .offensive-category-title {
            color: var(--primary-orange);
        }

        .defense-icon,
        .offensive-icon {
            font-size: 16px;
        }

        .defense-grid,
        .offensive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-sm);
        }

        .defense-stat,
        .offensive-stat {
            background: var(--bg-dark);
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: var(--spacing-sm);
            text-align: center;
            transition: all 0.3s ease;
        }

        .defense-stat:hover {
            border-color: var(--primary-cyan);
            background: var(--bg-light);
        }

        .offensive-stat:hover {
            border-color: var(--primary-orange);
            background: var(--bg-light);
        }

        .defense-stat-label,
        .offensive-stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-xs);
        }

        .defense-stat-value,
        .offensive-stat-value {
            font-size: 16px;
            color: var(--text-bright);
            font-weight: 600;
        }

        /* Resistance Grid */
        .resistance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-sm);
        }

        .resistance-stat {
            background: var(--bg-dark);
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            padding: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: all 0.3s ease;
        }

        .resistance-stat:hover {
            border-color: var(--primary-cyan);
            background: var(--bg-light);
        }

        .resistance-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 16px;
        }

        .resistance-icon.fire {
            background: rgba(255, 102, 0, 0.2);
            border: 1px solid rgba(255, 102, 0, 0.4);
        }

        .resistance-icon.ice {
            background: rgba(135, 206, 235, 0.2);
            border: 1px solid rgba(135, 206, 235, 0.4);
        }

        .resistance-icon.electric {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid rgba(255, 255, 0, 0.4);
        }

        .resistance-icon.earth {
            background: rgba(139, 69, 19, 0.2);
            border: 1px solid rgba(139, 69, 19, 0.4);
        }

        .resistance-icon.nature {
            background: rgba(34, 139, 34, 0.2);
            border: 1px solid rgba(34, 139, 34, 0.4);
        }

        .resistance-info {
            flex: 1;
        }

        .resistance-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .resistance-value {
            font-size: 14px;
            color: var(--text-bright);
            font-weight: 600;
        }

        /* Dashboard uses inventory.css for equipment styling */

        /* Stat Source Tooltip Styles */
        .stat-tooltip {
            position: fixed;
            background: var(--bg-dark);
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            min-width: 280px;
            max-width: 350px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
            font-family: var(--font-body);
            pointer-events: none;
        }

        .tooltip-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-gray);
            background: linear-gradient(135deg, rgba(255, 102, 0, 0.1) 0%, rgba(0, 255, 136, 0.1) 100%);
        }

        .tooltip-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-cyan);
            margin-bottom: 4px;
        }

        .tooltip-total {
            font-size: 12px;
            color: var(--text-bright);
            font-weight: 600;
        }

        .tooltip-body {
            padding: 12px 16px;
        }

        .stat-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-gray);
            padding-bottom: 4px;
        }

        .stat-source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 12px;
        }

        .source-name {
            color: var(--text-normal);
        }

        .source-value {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="navbar">
        <div class="nav-brand">
            <div class="nav-logo"></div>
            <div>
                <div class="nav-username">AGENT RECON-7</div>
                <div class="nav-level">LEVEL 60 • PARAGON 40</div>
            </div>
        </div>
        <div class="nav-menu">
            <a href="dashboard.html" class="nav-item active">CHARACTER</a>
            <a href="inventory.html" class="nav-item">INVENTORY</a>
            <a href="missions.html" class="nav-item">MISSIONS</a>
            <a href="skills.html" class="nav-item">SKILLS</a>
            <a href="loadouts.html" class="nav-item">LOADOUTS</a>
            <a href="build-planner.html" class="nav-item">BUILD PLANNER</a>
            <a href="marketplace.html" class="nav-item">MARKET</a>
            <a href="crafting.html" class="nav-item">CRAFTING</a>
            <a href="armory.html" class="nav-item">ARMORY</a>
        </div>
    </nav>


    <!-- Main Content -->
    <div class="page-container">
        <!-- Character Page -->
        <div class="page-header">
            <h1 class="page-title">CHARACTER OVERVIEW</h1>
        </div>

        <div class="grid-2" style="gap: var(--spacing-md);">
            <!-- Power Budget & Equipment Card -->
            <div class="sidebar" style="min-width: 300px; max-width: 350px; background: var(--bg-medium); border: 1px solid var(--border-gray); border-radius: 4px; padding: var(--spacing-md);">
                <div class="card-header">
                    <h2 class="card-title">Power Budget</h2>
                </div>
                <div class="card-accent"></div>
                
                <div style="margin-bottom: var(--spacing-lg);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                        <span class="text-dim">USED</span>
                        <span class="text-cyan"><span class="power-used">372</span> / <span class="power-max">700</span></span>
                    </div>
                    <div class="power-progress-bar">
                        <div class="power-progress-fill" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Equipment Slots -->
                <div class="card-header">
                    <h3 class="card-title">Equipped Items</h3>
                </div>
                <div class="card-accent"></div>
                
                <div class="equipment-grid">
                    <!-- Row 1: Head, Shoulders | Primary Weapon -->
                    <div class="equipment-slot" data-slot="head">
                        <div class="equipment-placeholder">Head</div>
                    </div>
                    <div class="equipment-slot" data-slot="shoulders">
                        <div class="equipment-placeholder">Shoulders</div>
                    </div>
                    <div class="equipment-slot" data-slot="primary">
                        <div class="equipment-placeholder">Primary</div>
                    </div>
                    
                    <!-- Row 2: Chest, Back | Secondary Weapon -->
                    <div class="equipment-slot" data-slot="chest">
                        <div class="equipment-placeholder">Chest</div>
                    </div>
                    <div class="equipment-slot" data-slot="back">
                        <div class="equipment-placeholder">Back</div>
                    </div>
                    <div class="equipment-slot" data-slot="secondary">
                        <div class="equipment-placeholder">Secondary</div>
                    </div>
                    
                    <!-- Row 3: Gloves, Legs -->
                    <div class="equipment-slot" data-slot="gloves">
                        <div class="equipment-placeholder">Gloves</div>
                    </div>
                    <div class="equipment-slot" data-slot="legs">
                        <div class="equipment-placeholder">Legs</div>
                    </div>
                </div>
            </div>

            <!-- Core Attributes Section Removed -->

            <!-- Offensive Stats Section Removed -->

    <!-- Comprehensive Stats Debug Section -->
    <section class="comprehensive-stats" style="margin-top: 2rem; padding: 2rem; background: #1a1a1a; border-radius: 8px; border: 1px solid #333;">
        <h2 style="color: #00d4ff; margin-bottom: 1rem; font-size: 1.2rem; text-align: center;">📊 ALL CHARACTER STATS (Database Direct)</h2>
        <div id="all-stats-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; font-family: 'Courier New', monospace; font-size: 12px;">
            <div style="text-align: center; color: #666; grid-column: 1 / -1;">Loading stats...</div>
        </div>
    </section>
    
    <footer style="padding: 20px; text-align: center; font-size: 10px; color: #666; border-top: 1px solid #333; margin-top: 40px;">
        <div style="margin-bottom: 10px;">
            <button id="boostXP" onclick="boostCharacterXP()" style="
                padding: 8px 16px; 
                background: #00ff88; 
                color: #000; 
                border: none; 
                border-radius: 4px; 
                font-size: 11px; 
                font-weight: bold; 
                cursor: pointer;
                margin-right: 10px;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='#00cc66'" onmouseout="this.style.background='#00ff88'">
                🚀 BOOST +1000 XP
            </button>
            <button onclick="debugRecalculateStats()" style="
                padding: 8px 16px; 
                background: #00d4ff; 
                color: #000; 
                border: none; 
                border-radius: 4px; 
                font-size: 11px; 
                font-weight: bold; 
                cursor: pointer;
                transition: all 0.2s ease;
            " onmouseover="this.style.background='#00b8e6'" onmouseout="this.style.background='#00d4ff'">
                🔄 REFRESH STATS
            </button>
        </div>
        <div>
            <a href="../changelog.html" style="color: #666; text-decoration: none; border-bottom: 1px dotted #666;">CHANGELOG</a> • 
            <a href="../specs/index.html" style="color: #666; text-decoration: none; border-bottom: 1px dotted #666;">SPECS</a> • 
            <a href="../tuning/index.html" style="color: #666; text-decoration: none; border-bottom: 1px dotted #666;">TUNING</a> • 
            LAST UPDATED: 2025-08-19 • DASHBOARD VERSION: v1.03 • STATIC TEST MODE
        </div>
    </footer>

    <!-- Load page-specific components -->
    <script src="assets/js/api-client.js"></script>
    <script src="assets/js/character-header.js"></script>
    <script src="assets/js/tooltips.js?v=17"></script>
    <script src="assets/js/equipped-items-widget.js?v=2"></script>
    <script src="assets/js/skill-modifiers.js"></script>
    <script src="assets/js/skill-calculator.js"></script>
    <script src="assets/js/simple-skill-integration.js"></script>
    <!-- REMOVED character.js - it was interfering with equipped items display -->
    <script>
        console.log('=== DASHBOARD LOADING WITH BACKEND API ===');
        
        // Skill-enhanced stats display system
        window.SkillStatsDisplay = {
            characterStats: {},
            
            /**
             * Load and display character stats with skill bonuses
             */
            async loadCharacterStatsWithSkills(characterId) {
                try {
                    // Get detailed stats including skill bonuses
                    const response = await fetch(`/api/character/${characterId}/stats/detailed`);
                    if (!response.ok) throw new Error('Failed to fetch character stats');
                    
                    this.characterStats = await response.json();
                    console.log('Loaded character stats with skill bonuses:', this.characterStats);
                    
                    // Update stat displays
                    this.updateStatDisplays();
                    return this.characterStats;
                } catch (error) {
                    console.error('Error loading character stats:', error);
                    return {};
                }
            },

            /**
             * Update stat displays with skill bonus information
             */
            updateStatDisplays() {
                // Update Critical Hit Chance
                this.updateStatDisplay('crit-chance', 'critical_strike_chance_percent', (value) => 
                    `${(value * 100).toFixed(1)}%`
                );

                // Update Critical Hit Damage
                this.updateStatDisplay('crit-damage', 'critical_strike_damage_percent', (value) =>
                    `${(value * 100).toFixed(0)}%`
                );

                // Update Weapon Damage (if we have it)
                this.updateStatDisplay('weapon-damage', 'weapon_damage_percent', (value) =>
                    `+${(value * 100).toFixed(1)}%`
                );

                // Update elemental damage displays
                this.updateElementalDamageDisplays();

                // Update resistance displays  
                this.updateResistanceDisplays();
            },

            /**
             * Update a single stat display with skill bonus tooltip
             */
            updateStatDisplay(elementId, statName, formatter) {
                const element = document.getElementById(elementId);
                if (!element || !this.characterStats[statName]) return;

                const stat = this.characterStats[statName];
                const totalValue = stat.base_value + stat.equipment_bonus + stat.skill_bonus;
                
                // Update display value
                element.textContent = formatter ? formatter(totalValue) : totalValue.toFixed(1);

                // Add skill bonus indicator if there's a skill bonus
                if (stat.skill_bonus > 0) {
                    element.style.color = '#00ff88'; // Skill bonus color
                    element.setAttribute('data-tooltip', this.createSkillBonusTooltip(statName, stat));
                }
            },

            /**
             * Create tooltip showing skill bonus breakdown
             */
            createSkillBonusTooltip(statName, stat) {
                let tooltip = `<div class="stat-breakdown">`;
                tooltip += `<div class="stat-breakdown-title">${statName.replace(/_/g, ' ').toUpperCase()}</div>`;
                
                if (stat.base_value > 0) {
                    tooltip += `<div class="stat-source">Base: ${stat.base_value.toFixed(1)}</div>`;
                }
                if (stat.equipment_bonus > 0) {
                    tooltip += `<div class="stat-source">Equipment: +${stat.equipment_bonus.toFixed(1)}</div>`;
                }
                if (stat.skill_bonus > 0) {
                    tooltip += `<div class="stat-source skill-bonus">Skills: +${stat.skill_bonus.toFixed(1)}</div>`;
                }
                
                const total = stat.base_value + stat.equipment_bonus + stat.skill_bonus;
                tooltip += `<div class="stat-total">Total: ${total.toFixed(1)}</div>`;
                tooltip += `</div>`;
                
                return tooltip;
            },

            /**
             * Update elemental damage displays with typed bonuses
             */
            updateElementalDamageDisplays() {
                const elements = ['fire', 'ice', 'electric', 'earth', 'nature'];
                
                elements.forEach(element => {
                    // Check for damage conversion bonuses
                    const conversionStat = this.characterStats.damage_conversion_percent;
                    if (conversionStat?.skill_bonus_typed) {
                        const conversions = conversionStat.skill_bonus_typed;
                        const elementConversion = conversions.find(c => c.type === element);
                        
                        if (elementConversion) {
                            this.showElementalBonus(element, 'conversion', elementConversion.value);
                        }
                    }

                    // Check for damage multiplier bonuses
                    const multiplierStat = this.characterStats.damage_percent;
                    if (multiplierStat?.skill_bonus_typed) {
                        const multipliers = multiplierStat.skill_bonus_typed;
                        const elementMultiplier = multipliers.find(m => m.type === element);
                        
                        if (elementMultiplier) {
                            this.showElementalBonus(element, 'multiplier', elementMultiplier.value);
                        }
                    }
                });
            },

            /**
             * Show elemental bonus indicator
             */
            showElementalBonus(element, type, value) {
                // Create or update elemental bonus display
                const containerId = `${element}-damage-bonus`;
                let container = document.getElementById(containerId);
                
                if (!container) {
                    // Find a place to add it (try to find existing elemental stats section)
                    const statsContainer = document.querySelector('.offensive-stats');
                    if (statsContainer) {
                        container = document.createElement('div');
                        container.id = containerId;
                        container.className = 'elemental-bonus-indicator';
                        container.innerHTML = `
                            <span class="element-icon ${element}">🔥</span>
                            <span class="bonus-text">+${(value * 100).toFixed(1)}% ${element} ${type}</span>
                        `;
                        statsContainer.appendChild(container);
                    }
                }
            },

            /**
             * Update resistance displays
             */
            updateResistanceDisplays() {
                const resistanceStat = this.characterStats.resistance_percent;
                if (!resistanceStat?.skill_bonus_typed) return;

                const resistances = resistanceStat.skill_bonus_typed;
                
                resistances.forEach(resistance => {
                    this.showResistanceBonus(resistance.type, resistance.value);
                });
            },

            /**
             * Show resistance bonus indicator
             */
            showResistanceBonus(type, value) {
                const containerId = `${type}-resistance-bonus`;
                let container = document.getElementById(containerId);
                
                if (!container) {
                    const defenseContainer = document.querySelector('.defense-stats');
                    if (defenseContainer) {
                        container = document.createElement('div');
                        container.id = containerId;
                        container.className = 'resistance-bonus-indicator';
                        container.innerHTML = `
                            <span class="resistance-text">+${(value * 100).toFixed(1)}% ${type} resistance</span>
                        `;
                        defenseContainer.appendChild(container);
                    }
                }
            },

            /**
             * Calculate and update character stats when skills change
             */
            async recalculateStats(characterId) {
                try {
                    console.log('Recalculating stats for character:', characterId);
                    
                    // Trigger skill calculation
                    await window.SkillCalculator.updateCharacterStats(characterId);
                    
                    // Reload and display updated stats
                    await this.loadCharacterStatsWithSkills(characterId);
                    
                } catch (error) {
                    console.error('Error recalculating stats:', error);
                }
            }
        };
        
        // Initialize global game state object
        window.CourierGame = {
            data: {
                items: {},
                equippedItems: {},
                playerLevel: 60,
                paragonLevel: 40
            }
        };
        
        // Transform item data for tooltip system (comprehensive version)
        function transformItemForTooltip(item) {
            const tooltipItem = { ...item };
            
            // Convert snake_case to camelCase for tooltip system
            tooltipItem.powerCost = item.power_cost;
            tooltipItem.itemSubtype = item.item_subtype;
            tooltipItem.weaponType = item.weapon_type;
            
            // Convert separate damage fields to damage object
            if (item.damage_min && item.damage_max) {
                tooltipItem.damage = {
                    min: item.damage_min,
                    max: item.damage_max
                };
                tooltipItem.damageMin = item.damage_min;
                tooltipItem.damageMax = item.damage_max;
            }
            
            // Convert all weapon stats from snake_case to camelCase
            if (item.type === 'weapon') {
                tooltipItem.fireRate = item.fire_rate;
                tooltipItem.magazineSize = item.magazine_size;
                tooltipItem.ammoCapacity = item.ammo_capacity;
                tooltipItem.reloadSpeed = item.reload_speed;
                tooltipItem.adsSpeed = item.ads_speed;
                tooltipItem.rangeEffective = item.range_effective;
                tooltipItem.rangeMax = item.range_max;
                tooltipItem.critChance = item.crit_chance;
                tooltipItem.critDamage = item.crit_damage;
                tooltipItem.critMultiplier = item.crit_damage; // Same as critDamage
                tooltipItem.handling = item.handling;
                tooltipItem.accuracy = item.accuracy;
                tooltipItem.stability = item.stability;
                tooltipItem.recoil = item.recoil;
                
                // Convert percentages to proper format
                if (item.crit_chance) {
                    tooltipItem.critChance = item.crit_chance * 100; // Convert to percentage
                }
            }
            
            return tooltipItem;
        }

        // Setup stat tooltips (replaces CharacterSystem functionality)
        function setupStatTooltips() {
            console.log('Setting up stat tooltips...');
            
            // Setup core attribute tooltips
            const statItems = document.querySelectorAll('.stat-item');
            console.log('Found stat items:', statItems.length);
            statItems.forEach(statItem => {
                statItem.addEventListener('mouseenter', async (e) => {
                    if (window.CourierTooltips) {
                        const stat = statItem.dataset.stat;
                        const tooltipData = await getStatTooltipData(stat);
                        if (tooltipData) {
                            window.CourierTooltips.showTooltip(e, tooltipData);
                        }
                    }
                });
                
                statItem.addEventListener('mouseleave', () => {
                    if (window.CourierTooltips) {
                        window.CourierTooltips.hideTooltip();
                    }
                });
            });
            
            // Setup offensive stat tooltips
            const offensiveStats = document.querySelectorAll('.offensive-stat');
            console.log('Found offensive stats:', offensiveStats.length);
            offensiveStats.forEach(offensiveStat => {
                offensiveStat.addEventListener('mouseenter', async (e) => {
                    if (window.CourierTooltips) {
                        const statLabel = offensiveStat.querySelector('.offensive-stat-label');
                        const statValue = offensiveStat.querySelector('.offensive-stat-value');
                        if (statLabel && statValue) {
                            const tooltipData = await getDetailedOffensiveTooltip(statLabel.textContent, statValue.textContent);
                            window.CourierTooltips.showTooltip(e, tooltipData);
                        }
                    }
                });
                
                offensiveStat.addEventListener('mouseleave', () => {
                    if (window.CourierTooltips) {
                        window.CourierTooltips.hideTooltip();
                    }
                });
            });
            
            // Setup defensive stat tooltips
            const defensiveStats = document.querySelectorAll('.defense-stat');
            console.log('Found defensive stats:', defensiveStats.length);
            defensiveStats.forEach(defensiveStat => {
                defensiveStat.addEventListener('mouseenter', async (e) => {
                    if (window.CourierTooltips) {
                        const statLabel = defensiveStat.querySelector('.defense-stat-label');
                        const statValue = defensiveStat.querySelector('.defense-stat-value');
                        if (statLabel && statValue) {
                            const tooltipData = await getDetailedDefensiveTooltip(statLabel.textContent, statValue.textContent);
                            window.CourierTooltips.showTooltip(e, tooltipData);
                        }
                    }
                });
                
                defensiveStat.addEventListener('mouseleave', () => {
                    if (window.CourierTooltips) {
                        window.CourierTooltips.hideTooltip();
                    }
                });
            });
        }
        
        // Get detailed breakdown for offensive stats
        async function getDetailedOffensiveTooltip(statName, currentValue) {
            const equippedItems = window.CourierGame?.data?.equippedItems || {};
            const calculatedStats = await calculateCharacterStats(equippedItems);
            
            // Build description as HTML with proper line breaks
            let sources = [];
            
            // Different logic based on stat type
            switch(statName) {
                case 'Primary DPS':
                case 'Secondary DPS':
                case 'Melee DPS':
                    sources.push("Base Character: 0");
                    Object.entries(equippedItems).forEach(([slot, item]) => {
                        if (item && item.type === 'weapon') {
                            const dps = item.damage_min ? ((item.damage_min + item.damage_max) / 2 * (item.fire_rate || 60) / 60) : 0;
                            if (dps > 0) sources.push(`${item.name}: +${Math.round(dps)}`);
                        }
                    });
                    break;
                    
                case 'Crit Chance':
                    sources.push("Base Character: 5%");
                    Object.entries(equippedItems).forEach(([slot, item]) => {
                        if (item && item.crit_chance) {
                            sources.push(`${item.name}: +${(item.crit_chance * 100).toFixed(1)}%`);
                        }
                    });
                    // Add skill bonuses
                    if (calculatedStats.skillBonuses?.critical_strike_chance_percent) {
                        sources.push(`Skills: +${(calculatedStats.skillBonuses.critical_strike_chance_percent * 100).toFixed(1)}%`);
                    }
                    break;
                    
                case 'Crit Damage':
                    sources.push("Base Character: 150%");
                    Object.entries(equippedItems).forEach(([slot, item]) => {
                        if (item && item.crit_damage && item.crit_damage > 1) {
                            sources.push(`${item.name}: +${((item.crit_damage - 1) * 100).toFixed(0)}%`);
                        }
                    });
                    // Add skill bonuses
                    if (calculatedStats.skillBonuses?.critical_strike_damage_percent) {
                        sources.push(`Skills: +${(calculatedStats.skillBonuses.critical_strike_damage_percent * 100).toFixed(0)}%`);
                    }
                    break;
                    
                case 'Fire Damage':
                case 'Ice Damage':
                case 'Electric Damage':
                case 'Nature Damage':
                case 'Earth Damage':
                    let damageType = statName.toLowerCase().replace(' damage', '_damage');
                    let skillDamageType = statName.toLowerCase().replace(' damage', '');
                    // Handle nature damage mapping (poison in database)
                    if (damageType === 'nature_damage') {
                        damageType = 'poison_damage';
                    }
                    sources.push("Base Character: 0");
                    Object.entries(equippedItems).forEach(([slot, item]) => {
                        if (item && item.type === 'mod' && item[damageType + '_flat']) {
                            sources.push(`${item.name}: +${item[damageType + '_flat']}`);
                        }
                    });
                    // Add skill bonuses for flat elemental damage
                    if (calculatedStats.skillBonuses?.damage_flat) {
                        calculatedStats.skillBonuses.damage_flat.forEach(bonus => {
                            if (bonus.type === skillDamageType) {
                                sources.push(`Skills: +${bonus.value}`);
                            }
                        });
                    }
                    break;
                    
                default:
                    sources.push("Base Character: varies");
                    sources.push("Equipment bonuses calculated from equipped items");
            }
            
            // Format sources as HTML with each on a separate line
            const sourcesHtml = sources.map(source => 
                `<div style="padding: 4px 0; font-size: 12px; color: var(--text-normal); font-weight: normal;">• ${source}</div>`
            ).join('');
            
            return {
                name: statName,
                description: `<div style="margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim);">Sources</div>${sourcesHtml}`,
                type: 'stat',
                rarity: 'common',
                value: currentValue,
                customHtml: true
            };
        }
        
        // Get detailed breakdown for defensive stats
        async function getDetailedDefensiveTooltip(statName, currentValue) {
            const equippedItems = window.CourierGame?.data?.equippedItems || {};
            const calculatedStats = await calculateCharacterStats(equippedItems);
            
            let sources = [];
            
            switch(statName) {
                case 'Health':
                    sources.push("Base Character: 100");
                    Object.entries(equippedItems).forEach(([slot, item]) => {
                        if (item && item.health) {
                            sources.push(`${item.name}: +${item.health}`);
                        }
                    });
                    break;
                    
                case 'Health Regen':
                    sources.push("Base: 5% of total health per second");
                    sources.push(`Current: ${Math.round(calculatedStats.health * 0.05)}/sec`);
                    break;
                    
                case 'Energy Shield':
                    sources.push("Base: 30% of total health");
                    sources.push(`Current: ${Math.round(calculatedStats.health * 0.3)}`);
                    break;
                    
                case 'Armor':
                    sources.push("Base Character: 0");
                    Object.entries(equippedItems).forEach(([slot, item]) => {
                        if (item && item.armor) {
                            sources.push(`${item.name}: +${item.armor}`);
                        }
                    });
                    break;
                    
                case 'Fire Resistance':
                case 'Ice Resistance':
                case 'Electric Resistance':
                case 'Nature Resistance':
                case 'Earth Resistance':
                    const resType = statName.toLowerCase().replace(' resistance', '');
                    sources.push("Base Character: 0%");
                    Object.entries(equippedItems).forEach(([slot, item]) => {
                        if (item && item.resistances && item.resistances[resType]) {
                            sources.push(`${item.name}: +${item.resistances[resType]}%`);
                        }
                    });
                    // Add skill bonuses for resistance
                    if (calculatedStats.skillBonuses?.resistance_percent) {
                        calculatedStats.skillBonuses.resistance_percent.forEach(bonus => {
                            if (bonus.type === resType) {
                                sources.push(`Skills: +${(bonus.value * 100).toFixed(0)}%`);
                            }
                        });
                    }
                    break;
                    
                default:
                    sources.push("Base Character: varies");
                    sources.push("Equipment bonuses calculated from equipped items");
            }
            
            // Format sources as HTML with each on a separate line
            const sourcesHtml = sources.map(source => 
                `<div style="padding: 4px 0; font-size: 12px; color: var(--text-normal); font-weight: normal;">• ${source}</div>`
            ).join('');
            
            return {
                name: statName,
                description: `<div style="margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim);">Sources</div>${sourcesHtml}`,
                type: 'stat',
                rarity: 'common',
                value: currentValue,
                customHtml: true
            };
        }
        
        // Calculate real character stats from equipped items AND skills
        async function calculateCharacterStats(equippedItems) {
            // Get character data including level and power_max
            let characterLevel = 1;
            let characterPowerMax = 300; // Default for level 1
            let character = null;
            
            try {
                const activeCharacterResponse = await window.CourierAPI.getActiveCharacter();
                console.log('Active character response:', activeCharacterResponse);
                
                if (activeCharacterResponse && activeCharacterResponse.success && activeCharacterResponse.character) {
                    character = activeCharacterResponse.character;
                    characterLevel = character.level;
                    characterPowerMax = character.power_max || (300 + (characterLevel - 1) * 50);
                    console.log(`Using active character: ${character.name} (level ${characterLevel}, power_max ${characterPowerMax})`);
                } else {
                    console.log('No active character found, using fallback character 3');
                    // Fallback to character 3 for testing
                    const response = await fetch('/api/characters/3');
                    if (response.ok) {
                        character = await response.json();
                        characterLevel = character.level || 1;
                        characterPowerMax = character.power_max || (300 + (characterLevel - 1) * 50);
                        console.log(`Using fallback character: ${character.name} (level ${characterLevel}, power_max ${characterPowerMax})`);
                    }
                }
            } catch (e) {
                console.error('Error getting character data:', e);
                // Default character 3 for testing
                const response = await fetch('/api/characters/3');
                if (response.ok) {
                    character = await response.json();
                    characterLevel = character.level || 1;
                    characterPowerMax = character.power_max || (300 + (characterLevel - 1) * 50);
                    console.log(`Using error fallback character: ${character.name} (level ${characterLevel}, power_max ${characterPowerMax})`);
                }
            }
            
            console.log(`📊 Calculating stats using NEW STAT SYSTEM for level ${characterLevel} character (power_max: ${characterPowerMax})`);
            
            // 🔥 NEW: Fetch pre-calculated stats from database (event-driven)
            try {
                console.log('🔥 Fetching pre-calculated stats from database...');
                const statsResponse = await fetch(`/api/character-stats/${character.id}`);
                
                if (statsResponse.ok) {
                    const databaseStats = await statsResponse.json();
                    console.log('✅ Database stats loaded:', databaseStats);
                    
                    // Map database stats to dashboard format
                    const newStats = {
                        level: characterLevel,
                        power_max: characterPowerMax,
                        power_used: 0, // Will be calculated from equipment
                        
                        // PRIMARY ATTRIBUTES (from database)
                        vitality: databaseStats.vitality || 0,
                        precision: databaseStats.precision || 0, 
                        potency: databaseStats.potency || 0,
                        alacrity: databaseStats.alacrity || 0,
                        defense: databaseStats.defense || 0,
                        
                        // Map new stats to old names for display compatibility
                        vigor: databaseStats.vitality || 0,     
                        focus: databaseStats.precision || 0,   
                        force: databaseStats.potency || 0,     
                        momentum: databaseStats.alacrity || 0, 
                        resonance: databaseStats.potency || 0, 
                        
                        // DERIVED STATS (from database)
                        health: databaseStats.health || 100,
                        armor: 0, // Will add from equipment
                        crit_chance: databaseStats.critical_strike_chance_percent || 5,
                        crit_damage: databaseStats.critical_strike_damage_percent || 150,
                        accuracy: databaseStats.accuracy_percent || 75,
                        stability: 50,
                        
                        // TYPED DAMAGE STATS (extract from database arrays)
                        fire_damage: 0,
                        ice_damage: 0,
                        electric_damage: 0,
                        nature_damage: 0,
                        earth_damage: 0,
                        
                        // TYPED RESISTANCE STATS (extract from database arrays)
                        fire_resistance: 0,
                        ice_resistance: 0,
                        electric_resistance: 0,
                        nature_resistance: 0,
                        earth_resistance: 0
                    };
                    
                    // Extract typed stats from database JSON arrays
                    if (databaseStats.damage_percent && Array.isArray(databaseStats.damage_percent)) {
                        databaseStats.damage_percent.forEach(dmg => {
                            const key = `${dmg.type}_damage`;
                            if (newStats[key] !== undefined) {
                                newStats[key] = dmg.value * 100; // Convert to display format
                            }
                        });
                    }
                    
                    if (databaseStats.resistance_percent && Array.isArray(databaseStats.resistance_percent)) {
                        databaseStats.resistance_percent.forEach(res => {
                            const key = `${res.type}_resistance`;
                            if (newStats[key] !== undefined) {
                                newStats[key] = res.value;
                            }
                        });
                    }
                    
                    console.log('✅ Database stats mapped to dashboard format:', newStats);
                    var totalStats = { ...newStats };
                }
                
            } catch (error) {
                    console.error('❌ NEW STAT SYSTEM failed, falling back to old system:', error);
                    // Fall back to old hardcoded system if new system fails
                    var totalStats = {
                        level: characterLevel,
                        health: 100,
                        power_max: characterPowerMax,
                        armor: 0,
                        // OLD HARDCODED STATS (FALLBACK ONLY)
                        vigor: 250 + (characterLevel - 1) * 15,
                        focus: 300 + (characterLevel - 1) * 10,
                        force: 220 + (characterLevel - 1) * 12,
                        momentum: 180 + (characterLevel - 1) * 8,
                        resonance: 200 + (characterLevel - 1) * 10,
                        defense: 150 + (characterLevel - 1) * 7,
                        crit_chance: 5,
                        crit_damage: 150,
                        accuracy: 75,
                        stability: 50,
                        fire_resistance: 0,
                        ice_resistance: 0,
                        electric_resistance: 0,
                        nature_resistance: 0,
                        earth_resistance: 0,
                        power_used: 0,
                        fire_damage: 0,
                        ice_damage: 0,
                        electric_damage: 0,
                        nature_damage: 0,
                        earth_damage: 0
                    };
                }
            
            // Fallback stats if needed
            if (!totalStats) {
                console.log('⚠️ Using fallback stats system');
                totalStats = {
                    level: characterLevel,
                    health: 100,
                    power_max: characterPowerMax,
                    armor: 0,
                    vigor: 250 + (characterLevel - 1) * 15,
                    focus: 300 + (characterLevel - 1) * 10,
                    force: 220 + (characterLevel - 1) * 12,
                    momentum: 180 + (characterLevel - 1) * 8,
                    resonance: 200 + (characterLevel - 1) * 10,
                    defense: 150 + (characterLevel - 1) * 7,
                    crit_chance: 5,
                    crit_damage: 150
                };
            }
            
            if (false) {
                console.log('⚠️ CharacterStatCalculator not available or no character, using old system');
                // Old hardcoded system as fallback
                var totalStats = {
                    level: characterLevel,
                    health: 100,
                    power_max: characterPowerMax,
                    armor: 0,
                    // OLD HARDCODED STATS 
                    vigor: 250 + (characterLevel - 1) * 15,
                    focus: 300 + (characterLevel - 1) * 10,
                    force: 220 + (characterLevel - 1) * 12,
                    momentum: 180 + (characterLevel - 1) * 8,
                    resonance: 200 + (characterLevel - 1) * 10,
                    defense: 150 + (characterLevel - 1) * 7,
                    crit_chance: 5,
                    crit_damage: 150,
                    accuracy: 75,
                    stability: 50,
                    fire_resistance: 0,
                    ice_resistance: 0,
                    electric_resistance: 0,
                    nature_resistance: 0,
                    earth_resistance: 0,
                    power_used: 0,
                    fire_damage: 0,
                    ice_damage: 0,
                    electric_damage: 0,
                    nature_damage: 0,
                    earth_damage: 0
                };
            }
            
            // Add stats from each equipped item
            Object.values(equippedItems).forEach(item => {
                if (item) {
                    totalStats.health += item.health || 0;
                    totalStats.armor += item.armor || 0;
                    totalStats.power_used += item.power_cost || 0;
                    
                    // Add power capacity from armor (some armor increases max power)
                    if (item.type === 'armor' && item.power) {
                        totalStats.power_max += item.power || 0;
                    }
                    
                    // Add resistances
                    if (item.resistances) {
                        totalStats.ice_resistance += item.resistances.ice || 0;
                        totalStats.electric_resistance += item.resistances.electric || 0;
                        totalStats.fire_resistance += item.resistances.fire || 0;
                        totalStats.nature_resistance += item.resistances.nature || 0;
                        totalStats.earth_resistance += item.resistances.earth || 0;
                    }
                    
                    // Add weapon stats
                    if (item.type === 'weapon') {
                        totalStats.crit_chance += (item.crit_chance * 100) || 0;
                        totalStats.crit_damage += ((item.crit_damage - 1) * 100) || 0;
                        totalStats.accuracy += item.accuracy || 0;
                        totalStats.stability += item.stability || 0;
                    }
                    
                    // Add elemental damage from mods
                    if (item.type === 'mod') {
                        totalStats.ice_damage += item.ice_damage_flat || 0;
                        totalStats.electric_damage += item.electric_damage_flat || 0;
                        totalStats.fire_damage += item.fire_damage_flat || 0;
                        totalStats.nature_damage += item.nature_damage_flat || 0;
                        totalStats.earth_damage += item.earth_damage_flat || 0;
                    }
                }
            });
            
            // Add skill bonuses if skill system is available
            if (window.SkillModifiers) {
                console.log('🎯 SkillModifiers available - calculating skill bonuses...');
                try {
                    // Get active character ID first
                    let characterId = 3; // Default to character 3 for testing
                    
                    try {
                        const activeCharacter = await window.CourierAPI.getActiveCharacter();
                        if (activeCharacter && activeCharacter.id) {
                            characterId = activeCharacter.id;
                            console.log('📋 Active character:', characterId);
                        } else {
                            console.log('⚠️ No active character found, using default character:', characterId);
                        }
                    } catch (authError) {
                        console.log('⚠️ Auth error, using default character:', characterId);
                    }
                    
                    // Get character skills using existing endpoint
                    const response = await fetch(`/api/character/${characterId}/skills`);
                    console.log('📊 Character skills API response status:', response.status);
                    if (response.ok) {
                        const skillsData = await response.json();
                        console.log('📊 Skills data received:', skillsData);
                        
                        // Convert to the format expected by SkillModifiers
                        const purchasedSkills = skillsData
                            .filter(skill => skill.level > 0)
                            .map(skill => ({ skill_id: skill.skill_id, level: skill.level }));
                    
                        console.log('Found purchased skills for stat calculation:', purchasedSkills);
                        
                        if (purchasedSkills.length > 0) {
                            // Calculate skill bonuses using the existing skill modifier system
                            const skillBonuses = window.SkillModifiers.calculateSkillBonuses(purchasedSkills);
                            console.log('Calculated skill bonuses for dashboard:', skillBonuses);
                            
                            // Apply skill bonuses to totalStats - same pattern as equipment
                            if (skillBonuses.critical_strike_chance_percent) {
                                totalStats.crit_chance += (skillBonuses.critical_strike_chance_percent * 100);
                                console.log(`✅ Added skill crit chance: +${(skillBonuses.critical_strike_chance_percent * 100).toFixed(1)}%`);
                            }
                            
                            if (skillBonuses.critical_strike_damage_percent) {
                                totalStats.crit_damage += (skillBonuses.critical_strike_damage_percent * 100);
                                console.log(`✅ Added skill crit damage: +${(skillBonuses.critical_strike_damage_percent * 100).toFixed(1)}%`);
                            }
                            
                            // Apply weapon-related skill bonuses
                            if (skillBonuses.weapon_damage_percent) {
                                totalStats.weapon_damage_percent = (totalStats.weapon_damage_percent || 0) + (skillBonuses.weapon_damage_percent * 100);
                                console.log(`✅ Added weapon damage: +${(skillBonuses.weapon_damage_percent * 100).toFixed(1)}%`);
                            }
                            
                            // Apply movement and character bonuses
                            if (skillBonuses.movement_speed_percent) {
                                totalStats.movement_speed_percent = (totalStats.movement_speed_percent || 0) + (skillBonuses.movement_speed_percent * 100);
                                console.log(`✅ Added movement speed: +${(skillBonuses.movement_speed_percent * 100).toFixed(1)}%`);
                            }
                            
                            if (skillBonuses.damage_reduction_percent) {
                                totalStats.damage_reduction_percent = (totalStats.damage_reduction_percent || 0) + (skillBonuses.damage_reduction_percent * 100);
                                console.log(`✅ Added damage reduction: +${(skillBonuses.damage_reduction_percent * 100).toFixed(1)}%`);
                            }
                            
                            // Apply shield bonuses
                            if (skillBonuses.shield_capacity_percent) {
                                totalStats.shield_capacity_percent = (totalStats.shield_capacity_percent || 0) + (skillBonuses.shield_capacity_percent * 100);
                                console.log(`✅ Added shield capacity: +${(skillBonuses.shield_capacity_percent * 100).toFixed(1)}%`);
                            }
                            
                            if (skillBonuses.shield_regen_rate_percent) {
                                totalStats.shield_regen_rate_percent = (totalStats.shield_regen_rate_percent || 0) + (skillBonuses.shield_regen_rate_percent * 100);
                                console.log(`✅ Added shield regen rate: +${(skillBonuses.shield_regen_rate_percent * 100).toFixed(1)}%`);
                            }
                            
                            // Apply elemental damage bonuses
                            if (skillBonuses.damage_flat && Array.isArray(skillBonuses.damage_flat)) {
                                skillBonuses.damage_flat.forEach(bonus => {
                                    const damageType = `${bonus.type}_damage`;
                                    if (totalStats[damageType] !== undefined) {
                                        totalStats[damageType] += bonus.value;
                                        console.log(`✅ Added ${bonus.type} flat damage: +${bonus.value}`);
                                    }
                                });
                            }
                            
                            // Apply resistance bonuses (including armor as physical resistance)
                            if (skillBonuses.resistance_flat && Array.isArray(skillBonuses.resistance_flat)) {
                                skillBonuses.resistance_flat.forEach(bonus => {
                                    if (bonus.type === 'physical') {
                                        totalStats.armor += bonus.value;
                                        console.log(`✅ Added armor from skills: +${bonus.value}`);
                                    } else {
                                        const resistanceType = `${bonus.type}_resistance`;
                                        if (totalStats[resistanceType] !== undefined) {
                                            totalStats[resistanceType] += bonus.value;
                                            console.log(`✅ Added ${bonus.type} flat resistance: +${bonus.value}`);
                                        }
                                    }
                                });
                            }
                            
                            // Apply percentage resistance bonuses (like Heat Resistance)
                            if (skillBonuses.resistance_percent && Array.isArray(skillBonuses.resistance_percent)) {
                                skillBonuses.resistance_percent.forEach(bonus => {
                                    if (bonus.type === 'physical') {
                                        // Physical resistance as armor - convert percentage to flat value
                                        const armorBonus = bonus.value * 100; // 25% = 25 armor
                                        totalStats.armor += armorBonus;
                                        console.log(`✅ Added armor from ${bonus.type} resistance: +${armorBonus}`);
                                    } else {
                                        const resistanceType = `${bonus.type}_resistance`;
                                        if (totalStats[resistanceType] !== undefined) {
                                            const resistanceBonus = bonus.value * 100; // Convert to percentage
                                            totalStats[resistanceType] += resistanceBonus;
                                            console.log(`✅ Added ${bonus.type} resistance: +${resistanceBonus}%`);
                                        }
                                    }
                                });
                            }
                            
                            // Store skill bonuses for tooltip system
                            totalStats.skillBonuses = skillBonuses;
                        }
                    } else {
                        console.log('❌ Failed to fetch character skills');
                    }
                } catch (error) {
                    console.error('Error loading skill bonuses for stat calculation:', error);
                }
            } else {
                console.log('❌ SkillModifiers not available - skills not affecting stats');
            }
            
            // Calculate available power
            totalStats.power_available = totalStats.power_max - totalStats.power_used;
            
            return totalStats;
        }
        
        // Update dashboard stats display with real values
        function updateDashboardStats(calculatedStats) {
            // Update power budget section
            const powerUsedElement = document.querySelector('.power-used');
            const powerMaxElement = document.querySelector('.power-max');
            const powerAvailableElement = document.querySelector('.power-available');
            const powerProgressFill = document.querySelector('.power-progress-fill');
            
            if (powerUsedElement) powerUsedElement.textContent = calculatedStats.power_used;
            if (powerMaxElement) powerMaxElement.textContent = calculatedStats.power_max;
            if (powerAvailableElement) powerAvailableElement.textContent = calculatedStats.power_available;
            
            // Update power progress bar
            if (powerProgressFill && calculatedStats.power_max > 0) {
                const percentage = (calculatedStats.power_used / calculatedStats.power_max) * 100;
                powerProgressFill.style.width = `${Math.min(percentage, 100)}%`;
            }
            
            // Update stat values in the UI
            const statElements = {
                vigor: document.querySelector('[data-stat="vigor"] .stat-value'),
                focus: document.querySelector('[data-stat="focus"] .stat-value'), 
                force: document.querySelector('[data-stat="force"] .stat-value'),
                momentum: document.querySelector('[data-stat="momentum"] .stat-value'),
                resonance: document.querySelector('[data-stat="resonance"] .stat-value'),
                defense: document.querySelector('[data-stat="defense"] .stat-value'),
                precision: document.querySelector('[data-stat="precision"] .stat-value'),
                toughness: document.querySelector('[data-stat="toughness"] .stat-value')
            };
            
            // Update core attributes with their calculated values
            if (statElements.vigor) statElements.vigor.textContent = Math.round(calculatedStats.vigor);
            if (statElements.focus) statElements.focus.textContent = Math.round(calculatedStats.focus);
            if (statElements.force) statElements.force.textContent = Math.round(calculatedStats.force);
            if (statElements.momentum) statElements.momentum.textContent = Math.round(calculatedStats.momentum);
            if (statElements.resonance) statElements.resonance.textContent = Math.round(calculatedStats.resonance);
            if (statElements.defense) statElements.defense.textContent = Math.round(calculatedStats.defense);
            if (statElements.precision) statElements.precision.textContent = Math.round(calculatedStats.accuracy);
            if (statElements.toughness) statElements.toughness.textContent = Math.round(calculatedStats.armor);
            
            // Update offensive stats using correct IDs
            const offensiveElements = {
                crit_chance: document.getElementById('crit-chance'),
                crit_damage: document.getElementById('crit-damage'),
                weak_spot: document.getElementById('weak-spot-damage'),
                ice_damage: document.getElementById('ice-damage'),
                electric_damage: document.getElementById('electric-damage'),
                fire_damage: document.getElementById('fire-damage'),
                nature_damage: document.getElementById('nature-damage'),
                earth_damage: document.getElementById('earth-damage')
            };
            
            if (offensiveElements.crit_chance) offensiveElements.crit_chance.textContent = calculatedStats.crit_chance.toFixed(1) + '%';
            if (offensiveElements.crit_damage) offensiveElements.crit_damage.textContent = calculatedStats.crit_damage.toFixed(0) + '%';
            if (offensiveElements.weak_spot) offensiveElements.weak_spot.textContent = '2.0x'; // Base weak spot multiplier
            if (offensiveElements.ice_damage) offensiveElements.ice_damage.textContent = `+${calculatedStats.ice_damage || 0}`;
            if (offensiveElements.electric_damage) offensiveElements.electric_damage.textContent = `+${calculatedStats.electric_damage || 0}`;
            if (offensiveElements.fire_damage) offensiveElements.fire_damage.textContent = `+${calculatedStats.fire_damage || 0}`;
            if (offensiveElements.nature_damage) offensiveElements.nature_damage.textContent = `+${calculatedStats.nature_damage || 0}`;
            if (offensiveElements.earth_damage) offensiveElements.earth_damage.textContent = `+${calculatedStats.earth_damage || 0}`;
            
            // Update defensive stats using correct IDs
            const defensiveElements = {
                health: document.getElementById('total-health'),
                health_regen: document.getElementById('health-regen'),
                energy_shield: document.getElementById('energy-shield'),
                armor: document.getElementById('total-armor'),
                ice_res: document.getElementById('ice-resistance'),
                electric_res: document.getElementById('electric-resistance'),
                fire_res: document.getElementById('fire-resistance'),
                nature_res: document.getElementById('nature-resistance'),
                earth_res: document.getElementById('earth-resistance')
            };
            
            if (defensiveElements.health) defensiveElements.health.textContent = calculatedStats.health.toLocaleString();
            if (defensiveElements.health_regen) defensiveElements.health_regen.textContent = `${Math.round(calculatedStats.health * 0.05)}/sec`; // 5% of health per second
            if (defensiveElements.energy_shield) defensiveElements.energy_shield.textContent = Math.round(calculatedStats.health * 0.3).toLocaleString(); // 30% of health as shield
            if (defensiveElements.armor) defensiveElements.armor.textContent = calculatedStats.armor.toLocaleString();
            if (defensiveElements.ice_res) defensiveElements.ice_res.textContent = `${calculatedStats.ice_resistance}%`;
            if (defensiveElements.electric_res) defensiveElements.electric_res.textContent = `${calculatedStats.electric_resistance}%`;
            if (defensiveElements.fire_res) defensiveElements.fire_res.textContent = `${calculatedStats.fire_resistance}%`;
            if (defensiveElements.nature_res) defensiveElements.nature_res.textContent = `${calculatedStats.nature_resistance}%`;
            if (defensiveElements.earth_res) defensiveElements.earth_res.textContent = `${calculatedStats.earth_resistance}%`;
        }

        // Core attribute breakdown functions
        function getVigorBreakdown(vigorValue, calculatedStats) {
            const healthBonus = Math.floor(vigorValue * 0.15); // 15% health per vigor point
            const healthRegen = Math.floor(calculatedStats.health * 0.05); // 5% of total health per second
            const staminaBonus = Math.floor(vigorValue * 0.8); // 80% stamina per vigor point
            
            const effects = [
                `Health Bonus: +${healthBonus}`,
                `Health Regen: ${healthRegen}/sec`,
                `Stamina: +${staminaBonus}`
            ];
            
            const effectsHtml = effects.map(effect => 
                `<div style="padding: 4px 0; font-size: 12px; color: var(--text-normal); font-weight: normal;">• ${effect}</div>`
            ).join('');
            
            return `<div style="margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim);">Affects Health and Stamina</div>${effectsHtml}`;
        }

        function getFocusBreakdown(focusValue, calculatedStats) {
            const skillDamage = Math.floor(focusValue * 0.12); // 12% skill damage per focus point
            const cooldownReduction = Math.floor(focusValue * 0.05); // 5% cooldown reduction per focus point
            
            const effects = [
                `Skill Damage: +${skillDamage}%`,
                `Cooldown Reduction: ${cooldownReduction}%`
            ];
            
            const effectsHtml = effects.map(effect => 
                `<div style="padding: 4px 0; font-size: 12px; color: var(--text-normal); font-weight: normal;">• ${effect}</div>`
            ).join('');
            
            return `<div style="margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim);">Affects Skills</div>${effectsHtml}`;
        }

        function getForceBreakdown(forceValue, calculatedStats) {
            const weaponDamage = Math.floor(forceValue * 0.25); // 25% weapon damage per force point
            const critDamage = Math.floor(forceValue * 0.18); // 18% crit damage per force point
            const armorPen = Math.floor(forceValue * 0.08); // 8% armor penetration per force point
            const meleeBonus = Math.floor(forceValue * 0.3); // 30% melee damage per force point
            
            const effects = [
                `Weapon Damage: +${weaponDamage}%`,
                `Critical Damage: +${critDamage}%`,
                `Armor Penetration: ${armorPen}%`,
                `Melee Damage: +${meleeBonus}%`
            ];
            
            const effectsHtml = effects.map(effect => 
                `<div style="padding: 4px 0; font-size: 12px; color: var(--text-normal); font-weight: normal;">• ${effect}</div>`
            ).join('');
            
            return `<div style="margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim);">Affects Weapon Damage</div>${effectsHtml}`;
        }

        function getMomentumBreakdown(momentumValue, calculatedStats) {
            const moveSpeed = Math.floor(momentumValue * 0.06); // 6% move speed per momentum point
            const reloadSpeed = Math.floor(momentumValue * 0.12); // 12% reload speed per momentum point
            const dodgeChance = Math.floor(momentumValue * 0.04); // 4% dodge chance per momentum point  
            const attackSpeed = Math.floor(momentumValue * 0.08); // 8% attack speed per momentum point
            
            const effects = [
                `Movement Speed: +${moveSpeed}%`,
                `Reload Speed: +${reloadSpeed}%`,
                `Dodge Chance: ${dodgeChance}%`,
                `Attack Speed: +${attackSpeed}%`
            ];
            
            const effectsHtml = effects.map(effect => 
                `<div style="padding: 4px 0; font-size: 12px; color: var(--text-normal); font-weight: normal;">• ${effect}</div>`
            ).join('');
            
            return `<div style="margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim);">Affects Speed and Agility</div>${effectsHtml}`;
        }

        function getResonanceBreakdown(resonanceValue, calculatedStats) {
            const elemDamage = Math.floor(resonanceValue * 0.2); // 20% elemental damage per resonance point
            const elemResist = Math.floor(resonanceValue * 0.15); // 15% elemental resistance per resonance point
            const statusDuration = Math.floor(resonanceValue * 0.1); // 10% status effect duration per resonance point
            const statusResist = Math.floor(resonanceValue * 0.12); // 12% status resistance per resonance point
            
            const effects = [
                `Elemental Damage: +${elemDamage}%`,
                `Elemental Resistance: +${elemResist}%`,
                `Status Duration: +${statusDuration}%`,
                `Status Resistance: +${statusResist}%`
            ];
            
            const effectsHtml = effects.map(effect => 
                `<div style="padding: 4px 0; font-size: 12px; color: var(--text-normal); font-weight: normal;">• ${effect}</div>`
            ).join('');
            
            return `<div style="margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim);">Affects Elemental Power</div>${effectsHtml}`;
        }

        function getDefenseBreakdown(defenseValue, calculatedStats) {
            const armorBonus = Math.floor(defenseValue * 0.35); // 35% armor per defense point
            const damageReduction = Math.floor(calculatedStats.armor / (calculatedStats.armor + 300) * 100); // Armor formula
            const healthBonus = Math.floor(defenseValue * 0.08); // 8% health per defense point
            const resistanceBonus = Math.floor(defenseValue * 0.05); // 5% all resistance per defense point
            
            const effects = [
                `Armor: +${armorBonus} (${damageReduction}% damage reduction)`,
                `Health Bonus: +${healthBonus}%`,
                `All Resistances: +${resistanceBonus}%`
            ];
            
            const effectsHtml = effects.map(effect => 
                `<div style="padding: 4px 0; font-size: 12px; color: var(--text-normal); font-weight: normal;">• ${effect}</div>`
            ).join('');
            
            return `<div style="margin-bottom: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim);">Affects Defense and Survivability</div>${effectsHtml}`;
        }

        // Get tooltip data for each stat with real calculated values
        async function getStatTooltipData(stat) {
            const equippedItems = window.CourierGame?.data?.equippedItems || {};
            const calculatedStats = await calculateCharacterStats(equippedItems);
            
            // Get current stat values from UI
            const currentStats = {
                vigor: parseInt(document.querySelector('[data-stat="vigor"] .stat-value')?.textContent) || 280,
                focus: parseInt(document.querySelector('[data-stat="focus"] .stat-value')?.textContent) || 310,
                force: parseInt(document.querySelector('[data-stat="force"] .stat-value')?.textContent) || 245,
                momentum: parseInt(document.querySelector('[data-stat="momentum"] .stat-value')?.textContent) || 195,
                resonance: parseInt(document.querySelector('[data-stat="resonance"] .stat-value')?.textContent) || 220,
                defense: parseInt(document.querySelector('[data-stat="defense"] .stat-value')?.textContent) || 165
            };

            const statInfo = {
                vigor: {
                    name: 'Vigor',
                    description: getVigorBreakdown(currentStats.vigor, calculatedStats),
                    type: 'stat',
                    rarity: 'common',
                    value: currentStats.vigor,
                    customHtml: true
                },
                focus: {
                    name: 'Focus', 
                    description: getFocusBreakdown(currentStats.focus, calculatedStats),
                    type: 'stat',
                    rarity: 'common',
                    value: currentStats.focus,
                    customHtml: true
                },
                force: {
                    name: 'Force',
                    description: getForceBreakdown(currentStats.force, calculatedStats),
                    type: 'stat',
                    rarity: 'common',
                    value: currentStats.force,
                    customHtml: true
                },
                momentum: {
                    name: 'Momentum',
                    description: getMomentumBreakdown(currentStats.momentum, calculatedStats),
                    type: 'stat',
                    rarity: 'common',
                    value: currentStats.momentum,
                    customHtml: true
                },
                resonance: {
                    name: 'Resonance',
                    description: getResonanceBreakdown(currentStats.resonance, calculatedStats),
                    type: 'stat',
                    rarity: 'common',
                    value: currentStats.resonance,
                    customHtml: true
                },
                defense: {
                    name: 'Defense',
                    description: getDefenseBreakdown(currentStats.defense, calculatedStats),
                    type: 'stat',
                    rarity: 'common',
                    value: currentStats.defense,
                    customHtml: true
                },
                crit_chance: {
                    name: 'Critical Hit Chance',
                    description: `Chance for critical hits: ${calculatedStats.crit_chance.toFixed(1)}%`,
                    type: 'stat'
                },
                crit_damage: {
                    name: 'Critical Hit Damage', 
                    description: `Extra damage on critical hits: ${calculatedStats.crit_damage.toFixed(0)}%`,
                    type: 'stat'
                },
                armor: {
                    name: 'Armor',
                    description: `Damage reduction from armor: ${calculatedStats.armor}`,
                    type: 'stat'
                },
                health: {
                    name: 'Health',
                    description: `Maximum health points: ${calculatedStats.health}`,
                    type: 'stat'
                },
                fire_resistance: {
                    name: 'Fire Resistance',
                    description: `Resistance to fire damage: ${calculatedStats.fire_resistance}`,
                    type: 'stat'
                },
                ice_resistance: {
                    name: 'Ice Resistance', 
                    description: `Resistance to ice damage: ${calculatedStats.ice_resistance}`,
                    type: 'stat'
                },
                electric_resistance: {
                    name: 'Electric Resistance',
                    description: `Resistance to electric damage: ${calculatedStats.electric_resistance}`,
                    type: 'stat'
                }
            };
            
            return statInfo[stat] || null;
        }

        // Load character data directly from debug endpoint (bypasses auth issues)
        async function loadCharacterData() {
            try {
                console.log('🔄 Loading character data...');
                const response = await fetch('/api/debug/character/3');
                const result = await response.json();
                
                if (result.success && result.character) {
                    const char = result.character;
                    console.log('Character data loaded:', char);
                    
                    // Update UI elements with database values
                    document.querySelector('.power-max').textContent = char.power_max;
                    
                    // Update level, experience, etc. if elements exist
                    const levelElement = document.querySelector('.character-level');
                    if (levelElement) levelElement.textContent = char.level;
                    
                    const expElement = document.querySelector('.character-experience');  
                    if (expElement) expElement.textContent = char.experience;
                    
                    const skillPointsElement = document.querySelector('.skill-points-available');
                    if (skillPointsElement) skillPointsElement.textContent = char.skill_points_available;
                    
                    return char;
                } else {
                    console.error('Failed to load character data:', result);
                    return null;
                }
            } catch (error) {
                console.error('Error loading character data:', error);
                return null;
            }
        }

        // Load pre-calculated stats from database  
        async function loadCalculatedStats() {
            try {
                console.log('🔄 Loading calculated stats...');
                const response = await fetch('/api/character-stats/3');
                const stats = await response.json();
                console.log('Calculated stats loaded:', stats);
                
                // Update stat displays with database values
                const healthElement = document.querySelector('.stat-health');
                if (healthElement) healthElement.textContent = Math.round(stats.health || 0);
                
                const defenseElement = document.querySelector('.stat-defense');  
                if (defenseElement) defenseElement.textContent = Math.round(stats.defense || 0);
                
                const potencyElement = document.querySelector('.stat-potency');
                if (potencyElement) potencyElement.textContent = Math.round(stats.potency || 0);
                
                const vitalityElement = document.querySelector('.stat-vitality');
                if (vitalityElement) vitalityElement.textContent = Math.round(stats.vitality || 0);
                
                const precisionElement = document.querySelector('.stat-precision');  
                if (precisionElement) precisionElement.textContent = Math.round(stats.precision || 0);
                
                return stats;
            } catch (error) {
                console.error('Error loading calculated stats:', error);
                return {};
            }
        }

        // Simple function to load and display equipped items
        async function loadAndDisplayEquippedItems() {
            try {
                console.log('🔄 Dashboard: Loading equipped items using standard widget...');
                
                // Check if equipment grid exists
                const grid = document.querySelector('.equipment-grid');
                if (!grid) {
                    console.error('❌ Equipment grid not found in DOM');
                    return;
                }
                console.log('✅ Equipment grid found');
                
                // Use the standard equipped items widget from working inventory
                if (window.EquippedItemsWidget) {
                    console.log('✅ EquippedItemsWidget found, initializing...');
                    await window.EquippedItemsWidget.init(3);
                    console.log('✅ EquippedItemsWidget initialized successfully');
                    
                    // Verify items were loaded
                    const equippedSlots = document.querySelectorAll('.equipment-slot.equipped');
                    console.log(`✅ Found ${equippedSlots.length} equipped items in dashboard`);
                    
                } else {
                    console.error('❌ EquippedItemsWidget not loaded');
                    console.log('Available window objects:', Object.keys(window).filter(key => key.includes('quip')).join(', '));
                }
                
            } catch (error) {
                console.error('❌ Dashboard error loading equipped items:', error);
            }
        }
        
        // Debug function to manually recalculate stats
        window.debugRecalculateStats = async function() {
            console.log('🔄 Manual stat recalculation triggered...');
            try {
                const equippedItems = window.CourierGame?.data?.equippedItems || {};
                const calculatedStats = await calculateCharacterStats(equippedItems);
                updateDashboardStats(calculatedStats);
                console.log('✅ Manual recalculation complete:', calculatedStats);
                return calculatedStats;
            } catch (error) {
                console.error('❌ Manual recalculation failed:', error);
            }
        };

        // Load comprehensive stats list from database
        async function loadComprehensiveStats() {
            console.log('📊 Loading comprehensive stats from database...');
            try {
                const response = await fetch('/api/character-stats/3');
                if (!response.ok) {
                    throw new Error(`Failed to fetch comprehensive stats: ${response.statusText}`);
                }
                
                const allStats = await response.json();
                console.log('✅ Loaded', Object.keys(allStats).length, 'stats from database');
                
                displayComprehensiveStats(allStats);
            } catch (error) {
                console.error('❌ Error loading comprehensive stats:', error);
                document.getElementById('all-stats-container').innerHTML = 
                    '<div style="color: red; grid-column: 1 / -1;">Error loading stats: ' + error.message + '</div>';
            }
        }
        
        // Display all stats in organized sections
        function displayComprehensiveStats(stats) {
            const container = document.getElementById('all-stats-container');
            
            // Group stats by category based on comprehensive document
            const statCategories = {
                'Primary Attributes': ['vitality', 'precision', 'potency', 'alacrity', 'capacity', 'defense'],
                'Health & Survivability': [
                    'health', 'shield_capacity', 'health_regeneration_rate', 'health_regeneration_delay',
                    'shield_regeneration_rate', 'shield_delay', 'shield_delay_change_percent',
                    'damage_reduction_percent', 'healing_effectiveness_percent', 'shield_gate_percent',
                    'recovery_speed_percent', 'revival_speed_percent'
                ],
                'Critical Strike & Accuracy': [
                    'critical_strike_chance_percent', 'critical_strike_damage_percent',
                    'accuracy_percent', 'weak_spot_damage_percent'
                ],
                'Primary Weapon (Base Stats)': [
                    'primary_weapon_damage_min', 'primary_weapon_damage_max', 'primary_weapon_base_magazine',
                    'primary_weapon_base_reload_time', 'primary_weapon_base_ads_time', 'primary_weapon_base_fire_rate',
                    'primary_weapon_base_range', 'primary_weapon_base_recoil', 'primary_weapon_base_spread',
                    'primary_weapon_base_handling', 'primary_weapon_type'
                ],
                'Secondary Weapon (Base Stats)': [
                    'secondary_weapon_damage_min', 'secondary_weapon_damage_max', 'secondary_weapon_base_magazine',
                    'secondary_weapon_base_reload_time', 'secondary_weapon_base_ads_time', 'secondary_weapon_base_fire_rate',
                    'secondary_weapon_base_range', 'secondary_weapon_base_recoil', 'secondary_weapon_base_spread',
                    'secondary_weapon_base_handling', 'secondary_weapon_type'
                ],
                'Universal Weapon Modifiers': [
                    'magazine_size_change_percent', 'reload_speed_percent', 'ads_speed_percent',
                    'fire_rate_percent', 'range_percent', 'recoil_reduction_percent',
                    'spread_reduction_percent', 'handling_percent', 'armor_penetration_percent',
                    'projectile_speed_percent', 'projectile_count_bonus', 'ricochet_chance_percent',
                    'piercing_targets_bonus'
                ],
                'Movement & Mobility': [
                    'movement_speed_percent', 'sprint_speed_percent', 'crouch_speed_percent',
                    'slide_speed_percent', 'jump_height_percent', 'air_control_percent',
                    'fall_damage_reduction_percent', 'dodge_distance_percent', 'dodge_cooldown_percent'
                ],
                'Ability System': [
                    'cooldown_reduction_percent', 'ability_damage_percent', 'ability_radius_percent',
                    'ability_duration_percent', 'ability_range_percent', 'ultimate_charge_rate_percent',
                    'ability_cost_reduction_percent', 'combo_damage_percent'
                ],
                'Power System': [
                    'power_max', 'power_efficiency_item_bonus', 'loadout_power_cost'
                ],
                'Typed Stats': [
                    'damage_percent', 'weapon_type_damage_flat', 'weapon_type_damage_percent',
                    'resistance_percent', 'status_effect_chance', 'status_effect_duration_percent',
                    'status_effect_resistance', 'damage_vs_target_percent', 'ammo_capacity',
                    'cooldown_reduction_typed', 'class_skill_modifier'
                ]
            };
            
            let html = '';
            
            // Display organized categories
            for (const [categoryName, statNames] of Object.entries(statCategories)) {
                html += `<div style="background: #222; padding: 1rem; border-radius: 6px; border-left: 3px solid #00d4ff;">`;
                html += `<h3 style="color: #00d4ff; font-size: 14px; margin: 0 0 0.5rem 0;">${categoryName}</h3>`;
                
                for (const statName of statNames) {
                    const value = stats[statName];
                    if (value !== undefined) {
                        let displayValue;
                        if (Array.isArray(value)) {
                            displayValue = `[${value.length} entries]`;
                        } else if (typeof value === 'number') {
                            displayValue = value.toFixed(2);
                        } else {
                            displayValue = String(value);
                        }
                        
                        html += `<div style="margin: 2px 0; display: flex; justify-content: space-between;">`;
                        html += `<span style="color: #ccc;">${statName}:</span>`;
                        html += `<span style="color: #fff; font-weight: bold;">${displayValue}</span>`;
                        html += `</div>`;
                    }
                }
                html += `</div>`;
            }
            
            // Display any uncategorized stats
            const categorizedStats = new Set(Object.values(statCategories).flat());
            const uncategorized = Object.keys(stats).filter(key => !categorizedStats.has(key));
            
            if (uncategorized.length > 0) {
                html += `<div style="background: #2a1a1a; padding: 1rem; border-radius: 6px; border-left: 3px solid #ff6b00;">`;
                html += `<h3 style="color: #ff6b00; font-size: 14px; margin: 0 0 0.5rem 0;">Other Stats (${uncategorized.length})</h3>`;
                
                for (const statName of uncategorized.sort()) {
                    const value = stats[statName];
                    let displayValue;
                    if (Array.isArray(value)) {
                        displayValue = `[${value.length} entries]`;
                    } else if (typeof value === 'number') {
                        displayValue = value.toFixed(2);
                    } else {
                        displayValue = String(value);
                    }
                    
                    html += `<div style="margin: 2px 0; display: flex; justify-content: space-between;">`;
                    html += `<span style="color: #ccc;">${statName}:</span>`;
                    html += `<span style="color: #fff; font-weight: bold;">${displayValue}</span>`;
                    html += `</div>`;
                }
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }
        
        // Debug function to boost character XP
        window.boostCharacterXP = async function() {
            const button = document.getElementById('boostXP');
            const originalText = button.textContent;
            
            try {
                button.textContent = '⏳ Boosting...';
                button.disabled = true;
                console.log('🚀 Boosting character XP...');
                
                // Get active character or use default
                let characterId = 3; // Default for testing
                try {
                    const activeCharacter = await window.CourierAPI.getActiveCharacter();
                    if (activeCharacter && activeCharacter.id) {
                        characterId = activeCharacter.id;
                    }
                } catch (e) {
                    console.log('Using default character ID for XP boost');
                }
                
                // Add XP via API (we'll need to create this endpoint)
                const response = await fetch(`/api/character/${characterId}/boost-xp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        xp: 1000
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ XP boost successful:', result);
                    
                    button.textContent = '✅ +1000 XP!';
                    button.style.background = '#00ff88';
                    
                    // Refresh the dashboard to show updated level/skills
                    setTimeout(async () => {
                        await loadAndDisplayEquippedItems();
                        if (window.CharacterHeader) {
                            await window.CharacterHeader.refresh();
                        }
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 1500);
                    
                } else {
                    throw new Error(`Failed to boost XP: ${response.status}`);
                }
                
            } catch (error) {
                console.error('❌ XP boost failed:', error);
                button.textContent = '❌ Failed';
                button.style.background = '#ff4444';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#00ff88';
                    button.disabled = false;
                }, 2000);
            }
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== DOM CONTENT LOADED ===');
            
            try {
                // Test API connection
                const health = await window.CourierAPI.healthCheck();
                console.log('API Health Check:', health);
                
                // Initialize tooltips with debugging
                console.log('Checking tooltip system...', window.CourierTooltips);
                if (window.CourierTooltips) {
                    window.CourierTooltips.init();
                    console.log('Tooltips initialized successfully');
                    console.log('Available tooltip methods:', Object.keys(window.CourierTooltips));
                } else {
                    console.error('CourierTooltips not found - tooltip system not loaded');
                    console.log('Available window objects:', Object.keys(window).filter(key => key.includes('tooltip') || key.includes('Tooltip')));
                }
                
                // Load character data from database (no auth required)
                await loadCharacterData();
                
                // Load pre-calculated stats from database  
                await loadCalculatedStats();
                
                // Load comprehensive stats list
                await loadComprehensiveStats();
                
                // Simple equipped items display - ENSURE IT LOADS LAST
                setTimeout(async () => {
                    await loadAndDisplayEquippedItems();
                }, 100);

                // Initialize simple skill integration
                if (window.SimpleSkillIntegration) {
                    console.log('Initializing simple skill integration...');
                    await window.SimpleSkillIntegration.init();
                }
                
                // DISABLE CHARACTER SYSTEM COMPLETELY - it's interfering with equipped items display
                // The character system keeps overwriting our equipment slots
                console.log('Character system disabled to prevent equipment display conflicts');
                
                // Add event listener for skill changes
                window.addEventListener('skillStatsUpdated', async (event) => {
                    console.log('Skills updated, refreshing character stats...', event.detail);
                    const activeCharacter = await window.CourierAPI.getActiveCharacter();
                    if (activeCharacter && activeCharacter.id) {
                        await window.SkillStatsDisplay.loadCharacterStatsWithSkills(activeCharacter.id);
                    }
                });

                // Add window focus listener to refresh dashboard when returning from other pages
                window.addEventListener('focus', async () => {
                    console.log('Dashboard gained focus - refreshing equipment and stats...');
                    
                    // Refresh skill bonuses too
                    if (window.SimpleSkillIntegration) {
                        await window.SimpleSkillIntegration.refresh();
                    }
                    try {
                        await loadAndDisplayEquippedItems(); // This also updates stats
                        
                        // Refresh character header if available
                        if (window.CharacterHeader) {
                            await window.CharacterHeader.refresh();
                        }
                    } catch (error) {
                        console.error('Error refreshing dashboard on focus:', error);
                    }
                });

                // Auto-refresh equipment data every 5 seconds to catch changes from inventory page
                setInterval(async () => {
                    try {
                        console.log('🔄 Auto-refreshing equipment data...');
                        await loadAndDisplayEquippedItems();
                    } catch (error) {
                        console.error('Error in auto-refresh:', error);
                    }
                }, 5000);
                
                // Setup stat tooltips (replaces CharacterSystem stat tooltips)
                setupStatTooltips();
                
                console.log('=== DASHBOARD LOADED WITH BACKEND API ===');
            } catch (error) {
                console.error('=== DASHBOARD API FAILED ===', error);
                
                // Show error message
                const equipmentGrid = document.querySelector('.equipment-grid');
                if (equipmentGrid) {
                    equipmentGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; color: red; padding: 20px; text-align: center;">
                            <strong>Backend Connection Failed</strong><br>
                            Make sure the backend server is running on port 3001.<br>
                            Error: ${error.message}
                        </div>
                    `;
                }
            }
        });
    </script>
    
    <!-- Character Stat Calculation System -->
    <script src="assets/js/skill-modifiers.js"></script>
    <script src="assets/js/character-stat-calculator.js"></script>
</body>
</html>